{% from 'partials/navigation.html' import sidebar_navigation, mobile_navigation %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_dev %}[DEV] {% endif %}Daily Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- ê°œë°œ í™˜ê²½ ë°°ë„ˆ -->
    {% if app_env == "dev" %}
    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 px-4 text-center font-semibold shadow-md">
        ğŸš§ ê°œë°œ í™˜ê²½ (DEV) - í¬íŠ¸ 8000 | DB: {{ database_url.split('/')[-1] }}
    </div>
    {% endif %}

<div class="min-h-screen bg-gray-50">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64 xl:mr-80 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">âš¡ Daily Flow</h1>
                    <p class="text-sm sm:text-base text-gray-600">{{ today_date or "ë‚ ì§œ ì—†ìŒ" }}</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- ë©”ëª¨ í† ê¸€ ë²„íŠ¼ (ì‘ì€ í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
                    <button
                        id="mobile-memo-toggle"
                        class="xl:hidden p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-md"
                        title="ë©”ëª¨ ë³´ê¸°"
                    >
                        ğŸ“
                    </button>
                    <div class="text-right">
                        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-blue-600">{{ summary.completed }}/{{ summary.total }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">ì™„ë£Œ</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64 xl:mr-80">
        <!-- ë¹ ë¥¸ í•  ì¼ ì¶”ê°€ -->
        <div class="bg-white mt-6 p-4 sm:p-6 lg:p-8 rounded-lg shadow-sm border">
            <div class="flex flex-col sm:flex-row gap-3 mb-3">
                <input
                    type="text"
                    id="quick-todo-input"
                    placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    class="flex-1 px-4 py-3 sm:py-2 text-base sm:text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    maxlength="200"
                />
                <div class="flex gap-2">
                    <button
                        id="detailed-todo-btn"
                        type="button"
                        class="px-4 py-3 sm:py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-xs lg:text-sm font-medium"
                        title="ìƒì„¸ ì…ë ¥"
                    >
                        <span class="hidden sm:inline">ìƒì„¸ </span>âš™ï¸
                    </button>
                    <button
                        id="quick-add-btn"
                        type="button"
                        class="px-6 py-3 sm:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 min-w-[80px] sm:min-w-[60px] text-sm font-medium"
                    >
                        ì¶”ê°€
                    </button>
                </div>
            </div>

            <!-- ìƒì„¸ ì…ë ¥ í¼ (ìˆ¨ê¹€) -->
            <div id="detailed-form" class="hidden mt-4 p-4 sm:p-6 bg-gray-50 rounded-lg border">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ìƒì„¸ ë‚´ìš©</label>
                        <textarea
                            id="todo-description"
                            placeholder="í•  ì¼ì— ëŒ€í•œ ìƒì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                            <select id="category-select" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="ì—…ë¬´">ì—…ë¬´</option>
                                <option value="ê°œì¸">ê°œì¸</option>
                                <option value="í•™ìŠµ">í•™ìŠµ</option>
                                <option value="ê±´ê°•">ê±´ê°•</option>
                                <option value="ê´€ê³„">ê´€ê³„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë¶„)</label>
                            <input
                                type="number"
                                id="estimated-minutes"
                                placeholder="30"
                                min="1"
                                max="480"
                                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                            />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì—¬ì •</label>
                        <select id="journey-select" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">ì—¬ì • ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                            <!-- ì—¬ì • ëª©ë¡ì€ JavaScriptë¡œ ë¡œë“œ -->
                        </select>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 mt-2">
                        <button
                            id="detailed-add-btn"
                            type="button"
                            class="flex-1 px-4 py-3 sm:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            ìƒì„¸ ì¶”ê°€
                        </button>
                        <button
                            id="cancel-detailed-btn"
                            type="button"
                            class="px-4 py-3 sm:py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm"
                        >
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© -->
        {% if summary.total > 0 %}
        <div class="mt-6">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm sm:text-base font-medium text-gray-700">ì˜¤ëŠ˜ì˜ ì§„í–‰ìƒí™©</span>
                    <span class="text-sm sm:text-base text-gray-500">{{ summary.completion_rate }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 sm:h-4">
                    <div
                        class="bg-blue-600 h-3 sm:h-4 rounded-full transition-all duration-300"
                        style="width: {{ summary.completion_rate }}%"
                    ></div>
                </div>
                <div class="flex justify-between items-end mt-3">
                    <div class="text-xs sm:text-sm text-gray-600">
                        <span>ì™„ë£Œ: {{ summary.completed }}ê°œ</span>
                        <span class="ml-4">ë‚¨ì€ ì¼: {{ summary.pending }}ê°œ</span>
                    </div>
                    <button
                        id="daily-reflection-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium"
                        title="ì˜¤ëŠ˜ í•˜ë£¨ ë§ˆê°í•˜ê¸°"
                    >
                        ğŸ“” í•˜ë£¨ ë§ˆê°
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- í• ì¼ ëª©ë¡ (ê¸°ì¡´ ì˜ì—­ ìœ ì§€) -->
        <div class="mt-6 mb-20 lg:mb-8">
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">ğŸ“‹</span>ì˜¤ëŠ˜ì˜ í• ì¼
                </h2>
                    <div id="todos-container" class="space-y-4">
                {% if today_todos %}
                    {% for todo in today_todos %}
                    <div class="todo-item
                        {% if todo.overdue_status == 'overdue' and not todo.is_completed %}
                            bg-red-50 border-red-200
                        {% elif todo.overdue_status == 'scheduled' %}
                            bg-yellow-50 border-yellow-200
                        {% else %}
                            bg-white border
                        {% endif %}
                        rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200" data-todo-id="{{ todo.id }}">
                        <div class="p-4 sm:p-5">
                            <div class="flex items-start">
                                <!-- ì²´í¬ë°•ìŠ¤ -->
                                <button
                                    class="todo-checkbox mr-3 sm:mr-4 p-1 mt-0.5"
                                    data-todo-id="{{ todo.id }}"
                                    aria-label="í•  ì¼ ì™„ë£Œ í† ê¸€"
                                >
                                    {% if todo.is_completed %}
                                    <div class="w-6 h-6 sm:w-7 sm:h-7 bg-green-500 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    {% else %}
                                    <div class="w-6 h-6 sm:w-7 sm:h-7 border-2 border-gray-300 rounded-full hover:border-blue-500 transition-colors"></div>
                                    {% endif %}
                                </button>

                                <!-- í•  ì¼ ë‚´ìš© -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm sm:text-base lg:text-lg font-medium text-gray-900 {{ 'line-through text-gray-500' if todo.is_completed else '' }}">
                                        {{ todo.title }}
                                    </h3>

                                    {% if todo.description %}
                                    <p class="text-xs sm:text-sm text-gray-600 mt-2 {{ 'line-through' if todo.is_completed else '' }}">{{ todo.description }}</p>
                                    {% endif %}

                                    <div class="flex flex-wrap gap-2 mt-3">
                                        {% if todo.journey %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-purple-100 text-purple-600 rounded-full">
                                            ğŸ¯ {{ todo.journey.title }}
                                        </span>
                                        {% endif %}

                                        {% if todo.category and todo.category != "ê¸°íƒ€" %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-blue-100 text-blue-600 rounded-full">
                                            ğŸ·ï¸ {{ todo.category }}
                                        </span>
                                        {% endif %}

                                        {% if todo.estimated_minutes %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-gray-100 text-gray-600 rounded-full">
                                            â±ï¸ {{ todo.estimated_minutes }}ë¶„
                                        </span>
                                        {% endif %}

                                        <!-- ê²½ê³¼ì¼ ë°°ì§€ ì¶”ê°€ -->
                                        {% if todo.overdue_text %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm
                                            {% if todo.overdue_status == 'overdue' %}bg-red-100 text-red-600{% endif %}
                                            {% if todo.overdue_status == 'today' %}bg-green-100 text-green-600{% endif %}
                                            {% if todo.overdue_status == 'scheduled' %}bg-yellow-100 text-yellow-600{% endif %}
                                            rounded-full">
                                            {% if todo.overdue_status == 'overdue' %}âš ï¸ {{ todo.overdue_text }}{% endif %}
                                            {% if todo.overdue_status == 'today' %}ğŸ“… ì˜¤ëŠ˜{% endif %}
                                            {% if todo.overdue_status == 'scheduled' %}â³ ì˜ˆì •{% endif %}
                                        </span>
                                        {% endif %}

                                        <!-- ë¯¸ë£¨ê¸° íšŸìˆ˜ ë°°ì§€ -->
                                        {% if todo.postpone_count and todo.postpone_count > 0 %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-orange-100 text-orange-600 rounded-full cursor-pointer"
                                              onclick="showPostponeHistory({{ todo.id }})"
                                              title="ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ ë³´ê¸°">
                                            ğŸ”„ {{ todo.postpone_count }}ë²ˆ ë¯¸ë£¸
                                        </span>
                                        {% endif %}
                                    </div>

                                    {% if todo.completion_reflection or todo.completion_image_path %}
                                    <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-md">
                                        {% if todo.completion_reflection %}
                                        <p class="text-xs sm:text-sm text-green-700 whitespace-pre-wrap"><span class="font-medium">íšŒê³ :</span>{{- todo.completion_reflection.replace('\r\n', '\n').replace('\r', '\n').lstrip() -}}</p>
                                        {% endif %}
                                        {% if todo.completion_image_path %}
                                        <div class="mt-2">
                                            <img src="{{ todo.completion_image_path }}"
                                                 alt="ì™„ë£Œ íšŒê³  ì´ë¯¸ì§€"
                                                 class="max-w-full max-h-32 sm:max-h-48 rounded cursor-pointer hover:opacity-80 transition-opacity"
                                                 onclick="showImageModal('{{ todo.completion_image_path }}')" />
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                                <div class="ml-2 sm:ml-3 flex gap-1 sm:gap-2">
                                    {% if not todo.is_completed %}
                                    <!-- í¸ì§‘ ë²„íŠ¼ -->
                                    <button
                                        class="edit-todo p-2 sm:p-2.5 text-gray-400 hover:text-blue-500 transition-colors rounded-md hover:bg-blue-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="í•  ì¼ í¸ì§‘"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                        </svg>
                                    </button>

                                    <!-- ë¯¸ë£¨ê¸° ë²„íŠ¼ -->
                                    <button
                                        class="reschedule-todo p-2 sm:p-2.5 text-gray-400 hover:text-yellow-500 transition-colors rounded-md hover:bg-yellow-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="í•  ì¼ ë¯¸ë£¨ê¸°"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    {% endif %}

                                    <!-- ì‚­ì œ ë²„íŠ¼ -->
                                    <button
                                        class="todo-delete p-2 sm:p-2.5 text-gray-400 hover:text-red-500 transition-colors rounded-md hover:bg-red-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="í•  ì¼ ì‚­ì œ"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-16 sm:py-20">
                        <div class="text-6xl sm:text-8xl mb-6">ğŸŒ±</div>
                        <h3 class="text-lg sm:text-xl lg:text-2xl font-medium text-gray-900 mb-3">ì•„ì§ í•  ì¼ì´ ì—†ë„¤ìš”!</h3>
                        <p class="text-gray-500 text-sm sm:text-base">ìœ„ì˜ ì…ë ¥ì°½ì—ì„œ ì˜¤ëŠ˜ì˜ ì²« í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    {{ mobile_navigation('daily_todos') }}

    {{ sidebar_navigation('daily_todos') }}

    <!-- ìš°ì¸¡ ê³ ì • ë©”ëª¨ íŒ¨ë„ (í° í™”ë©´ì—ì„œë§Œ í‘œì‹œ) -->
    <div class="hidden xl:block fixed top-0 right-0 w-80 h-full bg-white shadow-lg border-l z-30">
        <div class="flex flex-col h-full">
            <!-- ë©”ëª¨ íŒ¨ë„ í—¤ë” -->
            <div class="p-4 border-b bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">ğŸ“</span>ì˜¤ëŠ˜ì˜ ë©”ëª¨
                </h2>
            </div>

            <!-- ë©”ëª¨ ì…ë ¥ ì˜ì—­ -->
            <div class="p-4 border-b">
                <div class="space-y-3">
                    <textarea
                        id="memo-input"
                        placeholder="ì˜¤ëŠ˜ ê¸°ì–µí•˜ê³  ì‹¶ì€ ê²ƒë“¤ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            <span id="memo-char-count">0</span>/500ì
                        </span>
                        <button
                            id="add-memo-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            ë©”ëª¨ ì¶”ê°€
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë©”ëª¨ ëª©ë¡ ì˜ì—­ -->
            <div class="flex-1 flex flex-col">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">
                            ì‘ì„±í•œ ë©”ëª¨ <span id="memo-count" class="text-blue-600">0</span>ê°œ
                        </h3>
                        <button
                            id="clear-all-memos"
                            class="text-xs text-red-600 hover:text-red-800 hidden"
                        >
                            ì „ì²´ ì‚­ì œ
                        </button>
                    </div>
                </div>

                <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                <div id="memo-list" class="flex-1 overflow-y-auto">
                    <div id="empty-memo-state" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">ğŸ“</div>
                        <p class="text-sm">ì•„ì§ ì‘ì„±í•œ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-xs text-gray-400 mt-1">ìœ„ì—ì„œ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì™„ë£Œ ì‹œ íšŒê³  ëª¨ë‹¬ -->
<div id="reflection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md lg:max-w-lg">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-4">ì™„ë£Œ íšŒê³ </h3>
            <p class="text-sm sm:text-base text-gray-600 mb-6">
                ì´ í•  ì¼ì„ ì™„ë£Œí•˜ë©° ì–´ë–¤ ì ì´ ì¢‹ì•˜ë‚˜ìš”? ë°°ìš´ ì ì´ë‚˜ ëŠë‚€ ì ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.
            </p>
            <textarea
                id="reflection-text"
                placeholder="íšŒê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì„ íƒì‚¬í•­)"
                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                rows="4"
            ></textarea>

            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€ (ì„ íƒì‚¬í•­)
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors">
                    <input
                        type="file"
                        id="reflection-image"
                        accept="image/*"
                        class="hidden"
                        onchange="handleImagePreview(this)"
                    />
                    <label for="reflection-image" class="cursor-pointer">
                        <div id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</p>
                            <p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF, WebP (ìµœëŒ€ 10MB)</p>
                        </div>
                        <div id="image-preview" class="hidden">
                            <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded" />
                            <p class="text-xs text-gray-500 mt-2" id="image-name"></p>
                        </div>
                    </label>
                    <button
                        type="button"
                        id="remove-image"
                        class="hidden mt-2 text-xs text-red-600 hover:text-red-800"
                        onclick="removeImagePreview()"
                    >
                        ì´ë¯¸ì§€ ì œê±°
                    </button>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="complete-with-reflection"
                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base font-medium"
                >
                    ì™„ë£Œ
                </button>
                <button
                    id="cancel-reflection"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¸ë£¨ê¸° ëª¨ë‹¬ -->
<div id="reschedule-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-4">ì¼ì • ë³€ê²½</h3>
            <p class="text-sm sm:text-base text-gray-600 mb-4">
                ì–¸ì œë¡œ ë¯¸ë£¨ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <input
                type="date"
                id="reschedule-date"
                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base mb-4"
            />

            <div class="mb-6">
                <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ë¯¸ë£¨ê¸° ì‚¬ìœ  *</label>
                <input
                    type="text"
                    id="reschedule-reason"
                    placeholder="ì˜ˆ: íšŒì˜ê°€ ëŠ¦ê²Œ ëë‚¨, ì»¨ë””ì…˜ì´ ì•ˆ ì¢‹ìŒ..."
                    maxlength="100"
                    class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                    required
                />
                <p class="text-xs text-gray-500 mt-1">ìµœëŒ€ 100ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button
                    id="confirm-reschedule"
                    class="flex-1 px-6 py-3 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm sm:text-base font-medium"
                >
                    ë¯¸ë£¨ê¸°
                </button>
                <button
                    id="cancel-reschedule"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- í¸ì§‘ ëª¨ë‹¬ -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md lg:max-w-lg">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-6">í•  ì¼ í¸ì§‘</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì œëª©</label>
                    <input
                        type="text"
                        id="edit-title"
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                    />
                </div>
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ìƒì„¸ ë‚´ìš©</label>
                    <textarea
                        id="edit-description"
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                        rows="3"
                    ></textarea>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                            <select id="edit-category" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                <option value="ì—…ë¬´">ì—…ë¬´</option>
                                <option value="ê°œì¸">ê°œì¸</option>
                                <option value="í•™ìŠµ">í•™ìŠµ</option>
                                <option value="ê±´ê°•">ê±´ê°•</option>
                                <option value="ê´€ê³„">ê´€ê³„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë¶„)</label>
                            <input
                                type="number"
                                id="edit-estimated-minutes"
                                min="1"
                                max="480"
                                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                            />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì—¬ì •</label>
                        <select id="edit-journey" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">ì—¬ì • ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="save-edit"
                    class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm sm:text-base font-medium"
                >
                    ì €ì¥
                </button>
                <button
                    id="cancel-edit"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì¼ì¼ íšŒê³  ëª¨ë‹¬ -->
<div id="daily-reflection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg sm:text-xl font-medium text-gray-900">ğŸ“” ì˜¤ëŠ˜ í•˜ë£¨ íšŒê³ </h3>
                <button id="close-daily-reflection" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ì„±ê³¼ ìš”ì•½ -->
            <div id="today-summary" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-lg font-medium text-gray-900 mb-3">ğŸ“Š ì˜¤ëŠ˜ì˜ ì„±ê³¼</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div id="modal-total-todos" class="text-2xl font-bold text-blue-600">-</div>
                        <div class="text-sm text-gray-500">ì „ì²´ í•  ì¼</div>
                    </div>
                    <div>
                        <div id="modal-completed-todos" class="text-2xl font-bold text-green-600">-</div>
                        <div class="text-sm text-gray-500">ì™„ë£Œ</div>
                    </div>
                    <div>
                        <div id="modal-completion-rate" class="text-2xl font-bold text-purple-600">-%</div>
                        <div class="text-sm text-gray-500">ì™„ë£Œìœ¨</div>
                    </div>
                </div>
            </div>

            <!-- ì™„ë£Œ/ë¯¸ì™„ë£Œ í•  ì¼ ëª©ë¡ -->
            <div id="todo-breakdown" class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- ì™„ë£Œí•œ ì¼ë“¤ -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h5 class="font-medium text-green-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            ì™„ë£Œí•œ ì¼ë“¤
                        </h5>
                        <div id="completed-list" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </div>
                    </div>

                    <!-- ë¯¸ì™„ë£Œ ì¼ë“¤ -->
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h5 class="font-medium text-orange-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            ë¯¸ì™„ë£Œ ì¼ë“¤
                        </h5>
                        <div id="pending-list" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm sm:text-base font-medium text-gray-700">íšŒê³  ë‚´ìš©</label>
                        <button type="button" id="load-template" class="text-sm text-blue-600 hover:text-blue-800">
                            ğŸ“ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                    </div>
                    <textarea
                        id="daily-reflection-text"
                        placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©°... ì–´ë–¤ ì ì´ ì¢‹ì•˜ê³ , ë¬´ì—‡ì„ ë°°ì› ìœ¼ë©°, ë‚´ì¼ì€ ì–´ë–»ê²Œ í•˜ê³  ì‹¶ì€ì§€ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”."
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                        rows="8"
                        required
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ë§Œì¡±ë„</label>
                        <select id="satisfaction-score" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="5">â­â­â­â­â­ ë§¤ìš° ë§Œì¡±</option>
                            <option value="4">â­â­â­â­ ë§Œì¡±</option>
                            <option value="3">â­â­â­ ë³´í†µ</option>
                            <option value="2">â­â­ ì•„ì‰¬ì›€</option>
                            <option value="1">â­ ë§¤ìš° ì•„ì‰¬ì›€</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">ì—ë„ˆì§€ ë ˆë²¨</label>
                        <select id="energy-level" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="5">âš¡ ë§¤ìš° í™œê¸°ì°¸</option>
                            <option value="4">ğŸ”‹ í™œê¸°ì°¸</option>
                            <option value="3">ğŸ”‹ ë³´í†µ</option>
                            <option value="2">ğŸ”‹ ì•½ê°„ í”¼ê³¤</option>
                            <option value="1">ğŸª« ë§¤ìš° í”¼ê³¤</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="save-daily-reflection"
                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base font-medium"
                >
                    ğŸ’¾ íšŒê³  ì €ì¥í•˜ê¸°
                </button>
                <button
                    id="cancel-daily-reflection"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
<div id="postpone-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg sm:text-xl font-medium text-gray-900">ğŸ”„ ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬</h3>
                <button id="close-postpone-history" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="postpone-summary" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-md font-medium text-gray-900 mb-3">ğŸ“Š ìš”ì•½</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="text-gray-500">ì´ ë¯¸ë£¨ê¸° íšŸìˆ˜</div>
                        <div id="summary-postpone-count" class="text-lg font-bold text-orange-600">-</div>
                    </div>
                    <div>
                        <div class="text-gray-500">ì´ ì§€ì—° ì¼ìˆ˜</div>
                        <div id="summary-total-days" class="text-lg font-bold text-red-600">-ì¼</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="text-gray-500">ì²˜ìŒ ë“±ë¡ì¼</div>
                    <div id="summary-original-date" class="text-sm font-medium">-</div>
                </div>
            </div>

            <div id="postpone-history-list" class="space-y-3">
                <!-- íˆìŠ¤í† ë¦¬ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="flex justify-center mt-6">
                <button
                    id="close-postpone-history-btn"
                    class="px-6 py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm"
                >
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ ë³´ê¸° ëª¨ë‹¬ -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
        <button
            onclick="closeImageModal()"
            class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl z-10"
        >
            âœ•
        </button>
        <img id="modal-image" class="max-w-full max-h-full rounded-lg" />
    </div>
</div>

<!-- ëª¨ë°”ì¼ ë©”ëª¨ ëª¨ë‹¬ -->
<div id="mobile-memo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden xl:hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[80vh] flex flex-col">
            <!-- ëª¨ë‹¬ í—¤ë” -->
            <div class="p-4 border-b bg-gray-50 rounded-t-lg">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <span class="mr-2">ğŸ“</span>ì˜¤ëŠ˜ì˜ ë©”ëª¨
                    </h2>
                    <button
                        id="close-mobile-memo"
                        class="p-2 text-gray-400 hover:text-gray-600"
                    >
                        âœ•
                    </button>
                </div>
            </div>

            <!-- ë©”ëª¨ ì…ë ¥ ì˜ì—­ -->
            <div class="p-4 border-b">
                <div class="space-y-3">
                    <textarea
                        id="mobile-memo-input"
                        placeholder="ì˜¤ëŠ˜ ê¸°ì–µí•˜ê³  ì‹¶ì€ ê²ƒë“¤ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            <span id="mobile-memo-char-count">0</span>/500ì
                        </span>
                        <button
                            id="mobile-add-memo-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            ë©”ëª¨ ì¶”ê°€
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë©”ëª¨ ëª©ë¡ ì˜ì—­ -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">
                            ì‘ì„±í•œ ë©”ëª¨ <span id="mobile-memo-count" class="text-blue-600">0</span>ê°œ
                        </h3>
                        <button
                            id="mobile-clear-all-memos"
                            class="text-xs text-red-600 hover:text-red-800 hidden"
                        >
                            ì „ì²´ ì‚­ì œ
                        </button>
                    </div>
                </div>

                <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
                <div id="mobile-memo-list" class="flex-1 overflow-y-auto">
                    <div id="mobile-empty-memo-state" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">ğŸ“</div>
                        <p class="text-sm">ì•„ì§ ì‘ì„±í•œ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-xs text-gray-400 mt-1">ìœ„ì—ì„œ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentTodoId = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì—¬ì • ëª©ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', async () => {
    await loadMilestones();
});

// ì—¬ì • ëª©ë¡ ë¡œë“œ
async function loadMilestones() {
    try {
        const response = await fetch('/api/daily/journeys');
        if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('journey-select');

            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // ì—¬ì • ì˜µì…˜ ì¶”ê°€
            data.journeys.forEach(journey => {
                const option = document.createElement('option');
                option.value = journey.id;
                option.textContent = journey.title;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('ì—¬ì • ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ìƒì„¸ ì…ë ¥ í¼ í† ê¸€
document.getElementById('detailed-todo-btn').addEventListener('click', () => {
    const form = document.getElementById('detailed-form');
    const isHidden = form.classList.contains('hidden');

    if (isHidden) {
        form.classList.remove('hidden');
        document.getElementById('detailed-todo-btn').textContent = 'ğŸ“';
    } else {
        form.classList.add('hidden');
        document.getElementById('detailed-todo-btn').textContent = 'âš™ï¸';
        clearDetailedForm();
    }
});

// ìƒì„¸ ì…ë ¥ í¼ ì·¨ì†Œ
document.getElementById('cancel-detailed-btn').addEventListener('click', () => {
    document.getElementById('detailed-form').classList.add('hidden');
    document.getElementById('detailed-todo-btn').textContent = 'âš™ï¸';
    clearDetailedForm();
});

// ìƒì„¸ ì…ë ¥ í¼ ì´ˆê¸°í™”
function clearDetailedForm() {
    document.getElementById('todo-description').value = '';
    document.getElementById('journey-select').value = '';
    document.getElementById('category-select').value = 'ê¸°íƒ€';
    document.getElementById('estimated-minutes').value = '';
}

// ë¹ ë¥¸ í•  ì¼ ì¶”ê°€
document.getElementById('quick-add-btn').addEventListener('click', async () => {
    const title = document.getElementById('quick-todo-input').value.trim();
    if (!title) return;

    try {
        const formData = new FormData();
        formData.append('title', title);

        const response = await fetch('/api/daily/todos/quick', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            document.getElementById('quick-todo-input').value = '';
            location.reload();
        } else {
            alert('í•  ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ìƒì„¸ í•  ì¼ ì¶”ê°€
document.getElementById('detailed-add-btn').addEventListener('click', async () => {
    const title = document.getElementById('quick-todo-input').value.trim();
    if (!title) {
        alert('í•  ì¼ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('title', title);

        const description = document.getElementById('todo-description').value.trim();
        if (description) {
            formData.append('description', description);
        }

        const category = document.getElementById('category-select').value || 'ê¸°íƒ€';
        formData.append('category', category);

        const journeyId = document.getElementById('journey-select').value;
        if (journeyId) {
            formData.append('journey_id', journeyId);
        }

        const estimatedMinutes = document.getElementById('estimated-minutes').value.trim();
        if (estimatedMinutes && estimatedMinutes !== '') {
            formData.append('estimated_minutes', estimatedMinutes);
        }

        const response = await fetch('/api/daily/todos', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            document.getElementById('quick-todo-input').value = '';
            clearDetailedForm();
            document.getElementById('detailed-form').classList.add('hidden');
            document.getElementById('detailed-todo-btn').textContent = 'âš™ï¸';
            location.reload();
        } else {
            alert('í•  ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// í•  ì¼ ì™„ë£Œ í† ê¸€ (íšŒê³  í¬í•¨)
document.addEventListener('click', async (e) => {
    if (e.target.closest('.todo-checkbox')) {
        const button = e.target.closest('.todo-checkbox');
        const todoId = button.dataset.todoId;
        currentTodoId = todoId;

        try {
            // APIì—ì„œ í˜„ì¬ ìƒíƒœ í™•ì¸
            const response = await fetch(`/api/daily/todos/${todoId}`);
            const todo = await response.json();

            if (!todo.is_completed) {
                // ë¯¸ì™„ë£Œ -> ì™„ë£Œ: íšŒê³  ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('reflection-modal').classList.remove('hidden');
            } else {
                // ì™„ë£Œ -> ë¯¸ì™„ë£Œ: ë°”ë¡œ í† ê¸€
                await toggleTodoComplete(todoId, null);
            }
        } catch (error) {
            console.error('í•  ì¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ì‹œ ë°”ë¡œ í† ê¸€
            await toggleTodoComplete(todoId, null);
        }
    }
});

// íšŒê³ ì™€ í•¨ê»˜ ì™„ë£Œ
document.getElementById('complete-with-reflection').addEventListener('click', async () => {
    const reflection = document.getElementById('reflection-text').value.trim();
    const imageFile = document.getElementById('reflection-image').files[0];
    await toggleTodoComplete(currentTodoId, reflection, imageFile);

    document.getElementById('reflection-modal').classList.add('hidden');
    document.getElementById('reflection-text').value = '';
    removeImagePreview();
    currentTodoId = null;
});

// íšŒê³  ëª¨ë‹¬ ì·¨ì†Œ
document.getElementById('cancel-reflection').addEventListener('click', () => {
    document.getElementById('reflection-modal').classList.add('hidden');
    document.getElementById('reflection-text').value = '';
    removeImagePreview();
    currentTodoId = null;
});

// í•  ì¼ ì™„ë£Œ í† ê¸€ í•¨ìˆ˜
async function toggleTodoComplete(todoId, reflection, imageFile) {
    try {
        const formData = new FormData();
        if (reflection) {
            formData.append('reflection', reflection);
        }
        if (imageFile) {
            formData.append('reflection_image', imageFile);
        }

        const response = await fetch(`/api/daily/todos/${todoId}/complete`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í•  ì¼ ì‚­ì œ
document.addEventListener('click', async (e) => {
    if (e.target.closest('.todo-delete')) {
        const button = e.target.closest('.todo-delete');
        const todoId = button.dataset.todoId;

        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                const response = await fetch(`/api/daily/todos/${todoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    }
});

// í•  ì¼ ë¯¸ë£¨ê¸°
document.addEventListener('click', (e) => {
    if (e.target.closest('.reschedule-todo')) {
        const button = e.target.closest('.reschedule-todo');
        currentTodoId = button.dataset.todoId;

        // ë‚´ì¼ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('reschedule-date').value = tomorrow.toISOString().split('T')[0];

        document.getElementById('reschedule-modal').classList.remove('hidden');
    }
});

// ë¯¸ë£¨ê¸° í™•ì¸
document.getElementById('confirm-reschedule').addEventListener('click', async () => {
    const newDate = document.getElementById('reschedule-date').value;
    const reason = document.getElementById('reschedule-reason').value.trim();

    if (!newDate) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!reason) {
        alert('ë¯¸ë£¨ê¸° ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    if (reason.length > 100) {
        alert('ë¯¸ë£¨ê¸° ì‚¬ìœ ëŠ” 100ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('new_date', newDate);
        formData.append('reason', reason);

        const response = await fetch(`/api/daily/todos/${currentTodoId}/reschedule`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            document.getElementById('reschedule-modal').classList.add('hidden');
            // ëª¨ë‹¬ ì´ˆê¸°í™”
            document.getElementById('reschedule-reason').value = '';
            currentTodoId = null;
            location.reload();
        } else {
            const errorData = await response.json();
            alert(`ì¼ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ë¯¸ë£¨ê¸° ëª¨ë‹¬ ì·¨ì†Œ
document.getElementById('cancel-reschedule').addEventListener('click', () => {
    document.getElementById('reschedule-modal').classList.add('hidden');
    document.getElementById('reschedule-reason').value = '';
    currentTodoId = null;
});

// í•  ì¼ í¸ì§‘
document.addEventListener('click', async (e) => {
    if (e.target.closest('.edit-todo')) {
        const button = e.target.closest('.edit-todo');
        currentTodoId = button.dataset.todoId;

        try {
            // APIì—ì„œ í•  ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(`/api/daily/todos/${currentTodoId}`);
            if (!response.ok) {
                throw new Error('í•  ì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const todo = await response.json();

            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('edit-title').value = todo.title || '';
            document.getElementById('edit-description').value = todo.description || '';
            document.getElementById('edit-estimated-minutes').value = todo.estimated_minutes || '';

            // ì¹´í…Œê³ ë¦¬ ì„¤ì •
            const categorySelect = document.getElementById('edit-category');
            // APIì—ì„œ ì´ë¯¸ í•œêµ­ì–´ë¡œ ë°˜í™˜ë˜ë¯€ë¡œ ì§ì ‘ ì„¤ì •
            categorySelect.value = todo.category;

            // ì—¬ì • ì„¤ì •
            const journeySelect = document.getElementById('edit-journey');
            journeySelect.value = todo.journey_id || '';

            document.getElementById('edit-modal').classList.remove('hidden');
        } catch (error) {
            console.error('í•  ì¼ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('í•  ì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
});

// í¸ì§‘ ì €ì¥
document.getElementById('save-edit').addEventListener('click', async () => {
    const title = document.getElementById('edit-title').value.trim();
    if (!title) {
        alert('í•  ì¼ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('title', title);

        const description = document.getElementById('edit-description').value.trim();
        if (description) {
            formData.append('description', description);
        }

        const category = document.getElementById('edit-category').value || 'ê¸°íƒ€';
        formData.append('category', category);

        const estimatedMinutes = document.getElementById('edit-estimated-minutes').value.trim();
        if (estimatedMinutes && estimatedMinutes !== '') {
            formData.append('estimated_minutes', estimatedMinutes);
        }

        const journeyId = document.getElementById('edit-journey').value;
        if (journeyId) {
            formData.append('journey_id', journeyId);
        }

        const response = await fetch(`/api/daily/todos/${currentTodoId}`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            document.getElementById('edit-modal').classList.add('hidden');
            currentTodoId = null;
            location.reload();
        } else {
            alert('í•  ì¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// í¸ì§‘ ëª¨ë‹¬ ì·¨ì†Œ
document.getElementById('cancel-edit').addEventListener('click', () => {
    document.getElementById('edit-modal').classList.add('hidden');
    currentTodoId = null;
});

// Enter í‚¤ë¡œ í•  ì¼ ì¶”ê°€
document.getElementById('quick-todo-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const detailedForm = document.getElementById('detailed-form');
        if (detailedForm.classList.contains('hidden')) {
            document.getElementById('quick-add-btn').click();
        } else {
            document.getElementById('detailed-add-btn').click();
        }
    }
});


// ì¼ì¼ íšŒê³  ëª¨ë‹¬ ì—´ê¸°
document.getElementById('daily-reflection-btn').addEventListener('click', async () => {
    await loadReflectionData();
    document.getElementById('daily-reflection-modal').classList.remove('hidden');
});

// íšŒê³  ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
async function loadReflectionData() {
    try {
        const response = await fetch('/api/daily/reflection-summary');
        const data = await response.json();

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('modal-total-todos').textContent = data.summary.total || 0;
        document.getElementById('modal-completed-todos').textContent = data.summary.completed || 0;
        document.getElementById('modal-completion-rate').textContent = `${data.summary.completion_rate || 0}%`;

        // ì™„ë£Œí•œ ì¼ë“¤ ëª©ë¡
        const completedList = document.getElementById('completed-list');
        completedList.innerHTML = '';

        if (data.completed_todos && Object.keys(data.completed_todos).length > 0) {
            Object.entries(data.completed_todos).forEach(([category, todos]) => {
                if (todos.length > 0) {
                    const categoryName = getCategoryName(category);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<div class="font-medium text-green-700 mb-1">${categoryName}</div>`;

                    todos.forEach(todo => {
                        const todoDiv = document.createElement('div');
                        const timeStr = todo.completed_at ? ` (${todo.completed_at})` : '';
                        todoDiv.className = 'text-gray-600 ml-2';
                        todoDiv.textContent = `â€¢ ${todo.title}${timeStr}`;
                        categoryDiv.appendChild(todoDiv);
                    });
                    completedList.appendChild(categoryDiv);
                }
            });
        } else {
            completedList.innerHTML = '<div class="text-gray-500 italic">ì™„ë£Œí•œ ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }

        // ë¯¸ì™„ë£Œ ì¼ë“¤ ëª©ë¡
        const pendingList = document.getElementById('pending-list');
        pendingList.innerHTML = '';

        if (data.pending_todos && Object.keys(data.pending_todos).length > 0) {
            Object.entries(data.pending_todos).forEach(([category, todos]) => {
                if (todos.length > 0) {
                    const categoryName = getCategoryName(category);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<div class="font-medium text-orange-700 mb-1">${categoryName}</div>`;

                    todos.forEach(todo => {
                        const todoDiv = document.createElement('div');
                        const timeStr = todo.estimated_minutes ? ` (ì˜ˆìƒ ${todo.estimated_minutes}ë¶„)` : '';
                        todoDiv.className = 'text-gray-600 ml-2';
                        todoDiv.textContent = `â€¢ ${todo.title}${timeStr}`;
                        categoryDiv.appendChild(todoDiv);
                    });
                    pendingList.appendChild(categoryDiv);
                }
            });
        } else {
            pendingList.innerHTML = '<div class="text-gray-500 italic">ë¯¸ì™„ë£Œ ì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }

        // ì „ì—­ ë³€ìˆ˜ì— í…œí”Œë¦¿ ì €ì¥
        window.reflectionTemplate = data.reflection_template;

    } catch (error) {
        console.error('íšŒê³  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
        document.getElementById('modal-total-todos').textContent = '0';
        document.getElementById('modal-completed-todos').textContent = '0';
        document.getElementById('modal-completion-rate').textContent = '0%';
    }
}

// ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë³€í™˜ í•¨ìˆ˜
function getCategoryName(category) {
    const categoryNames = {
        'WORK': 'ğŸ’¼ ì—…ë¬´',
        'PERSONAL': 'ğŸ‘¤ ê°œì¸',
        'HEALTH': 'ğŸ’ª ê±´ê°•',
        'LEARNING': 'ğŸ“š í•™ìŠµ',
        'SOCIAL': 'ğŸ‘¥ ì‚¬íšŒ',
        'OTHER': 'ğŸ”¹ ê¸°íƒ€'
    };
    return categoryNames[category] || category;
}

// í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('load-template').addEventListener('click', () => {
    if (window.reflectionTemplate) {
        document.getElementById('daily-reflection-text').value = window.reflectionTemplate;
    } else {
        alert('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‹¬ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.');
    }
});

// ì¼ì¼ íšŒê³  ì·¨ì†Œ
document.getElementById('cancel-daily-reflection').addEventListener('click', () => {
    document.getElementById('daily-reflection-modal').classList.add('hidden');
    document.getElementById('daily-reflection-text').value = '';
    document.getElementById('satisfaction-score').value = '';
    document.getElementById('energy-level').value = '';
});

// X ë²„íŠ¼ìœ¼ë¡œ ë‹«ê¸°
document.getElementById('close-daily-reflection').addEventListener('click', () => {
    document.getElementById('daily-reflection-modal').classList.add('hidden');
    document.getElementById('daily-reflection-text').value = '';
    document.getElementById('satisfaction-score').value = '';
    document.getElementById('energy-level').value = '';
});

// ì¼ì¼ íšŒê³  ì €ì¥
document.getElementById('save-daily-reflection').addEventListener('click', async () => {
    const reflectionText = document.getElementById('daily-reflection-text').value.trim();
    const satisfactionScore = document.getElementById('satisfaction-score').value;
    const energyLevel = document.getElementById('energy-level').value;

    if (!reflectionText) {
        alert('íšŒê³  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const formData = new FormData();
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹

        formData.append('reflection_date', today);
        formData.append('reflection_text', reflectionText);

        if (satisfactionScore) {
            formData.append('satisfaction_score', satisfactionScore);
        }
        if (energyLevel) {
            formData.append('energy_level', energyLevel);
        }

        const response = await fetch('/api/reflections/', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            document.getElementById('daily-reflection-modal').classList.add('hidden');
            document.getElementById('daily-reflection-text').value = '';
            document.getElementById('satisfaction-score').value = '';
            document.getElementById('energy-level').value = '';

            alert('ğŸ“” ì˜¤ëŠ˜ì˜ íšŒê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\níšŒê³  íˆìŠ¤í† ë¦¬ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

            // íšŒê³  íˆìŠ¤í† ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í• ì§€ ë¬»ê¸°
            if (confirm('íšŒê³  íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = '/reflection-history';
            }
        } else {
            const errorData = await response.json();
            alert(`íšŒê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('íšŒê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ì—¬ì • ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
async function loadMilestones() {
    try {
        const response = await fetch('/api/daily/journeys');
        if (response.ok) {
            const data = await response.json();
            const journeys = data.journeys || [];

            // ì¶”ê°€ ëª¨ë‹¬ì˜ ì—¬ì • ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            const addMilestoneSelect = document.getElementById('journey-select');
            addMilestoneSelect.innerHTML = '<option value="">ì—¬ì • ì„ íƒ (ì„ íƒì‚¬í•­)</option>';

            // í¸ì§‘ ëª¨ë‹¬ì˜ ì—¬ì • ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            const editMilestoneSelect = document.getElementById('edit-journey');
            editMilestoneSelect.innerHTML = '<option value="">ì—¬ì • ì„ íƒ (ì„ íƒì‚¬í•­)</option>';

            journeys.forEach(journey => {
                const option = document.createElement('option');
                option.value = journey.id;
                option.textContent = journey.title;

                addMilestoneSelect.appendChild(option.cloneNode(true));
                editMilestoneSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('ì—¬ì • ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
function handleImagePreview(input) {
    const file = input.files[0];
    if (!file) return;

    // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        input.value = '';
        return;
    }

    // íŒŒì¼ íƒ€ì… ì²´í¬
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, GIF, WebPë§Œ ì§€ì›)');
        input.value = '';
        return;
    }

    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('image-upload-area').classList.add('hidden');
        document.getElementById('image-preview').classList.remove('hidden');
        document.getElementById('remove-image').classList.remove('hidden');

        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('image-name').textContent = file.name;
    };
    reader.readAsDataURL(file);
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì œê±°
function removeImagePreview() {
    document.getElementById('reflection-image').value = '';
    document.getElementById('image-upload-area').classList.remove('hidden');
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('remove-image').classList.add('hidden');
    document.getElementById('preview-img').src = '';
    document.getElementById('image-name').textContent = '';
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ í‘œì‹œ
function showImageModal(imagePath) {
    document.getElementById('modal-image').src = imagePath;
    document.getElementById('image-modal').classList.remove('hidden');
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('modal-image').src = '';
}

// ESC í‚¤ë¡œ ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ í‘œì‹œ
async function showPostponeHistory(todoId) {
    try {
        const response = await fetch(`/api/daily/todos/${todoId}/postpone-summary`);
        if (!response.ok) {
            throw new Error('ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('summary-postpone-count').textContent = data.postpone_count;
        document.getElementById('summary-total-days').textContent = `${data.total_days_postponed}ì¼`;
        document.getElementById('summary-original-date').textContent = new Date(data.original_date).toLocaleDateString('ko-KR');

        // íˆìŠ¤í† ë¦¬ ëª©ë¡ ìƒì„±
        const historyList = document.getElementById('postpone-history-list');
        historyList.innerHTML = '';

        if (data.full_history && data.full_history.length > 0) {
            data.full_history.forEach((history, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 border border-gray-200 rounded-md bg-gray-50';

                const fromDate = new Date(history.from_date).toLocaleDateString('ko-KR');
                const toDate = new Date(history.to_date).toLocaleDateString('ko-KR');
                const postponedAt = new Date(history.postponed_at).toLocaleString('ko-KR');

                historyItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">${index + 1}ë²ˆì§¸ ë¯¸ë£¨ê¸°</span>
                        <span class="text-xs text-gray-500">${postponedAt}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="font-medium">${fromDate}</span> â†’ <span class="font-medium">${toDate}</span>
                    </div>
                    <div class="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-orange-400">
                        ğŸ’­ ${history.reason}
                    </div>
                `;

                historyList.appendChild(historyItem);
            });
        } else {
            historyList.innerHTML = '<div class="text-center text-gray-500 py-4">ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('postpone-history-modal').classList.remove('hidden');

    } catch (error) {
        console.error('ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('close-postpone-history').addEventListener('click', () => {
    document.getElementById('postpone-history-modal').classList.add('hidden');
});

document.getElementById('close-postpone-history-btn').addEventListener('click', () => {
    document.getElementById('postpone-history-modal').classList.add('hidden');
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°ì— ë¯¸ë£¨ê¸° íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ì¶”ê°€
document.addEventListener('click', (e) => {
    if (e.target.id === 'reflection-modal') {
        document.getElementById('cancel-reflection').click();
    }
    if (e.target.id === 'reschedule-modal') {
        document.getElementById('cancel-reschedule').click();
    }
    if (e.target.id === 'edit-modal') {
        document.getElementById('cancel-edit').click();
    }
    if (e.target.id === 'daily-reflection-modal') {
        document.getElementById('cancel-daily-reflection').click();
    }
    if (e.target.id === 'postpone-history-modal') {
        document.getElementById('close-postpone-history').click();
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì—¬ì • ëª©ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    loadMilestones();
    loadMemosBasedOnScreenSize();
    setupMemoCharCounter();
});

// === ë©”ëª¨ ê´€ë ¨ ê¸°ëŠ¥ ===

// ê¸€ì ìˆ˜ ì¹´ìš´í„° ì„¤ì •
function setupMemoCharCounter() {
    const memoInput = document.getElementById('memo-input');
    const charCount = document.getElementById('memo-char-count');

    memoInput.addEventListener('input', () => {
        const currentLength = memoInput.value.length;
        charCount.textContent = currentLength;

        // ê¸€ì ìˆ˜ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
        if (currentLength > 450) {
            charCount.className = 'text-red-600';
        } else if (currentLength > 400) {
            charCount.className = 'text-yellow-600';
        } else {
            charCount.className = 'text-gray-500';
        }
    });
}

// í™”ë©´ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ ë©”ëª¨ ë¡œë”© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
async function loadMemosBasedOnScreenSize() {
    const isDesktopMode = window.innerWidth >= 1280; // xl breakpoint

    try {
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (isDesktopMode) {
            // ë°ìŠ¤í¬í†± ë©”ëª¨ íŒ¨ë„ ì—…ë°ì´íŠ¸
            displayMemos(memos);
        } else {
            // ëª¨ë°”ì¼ ë©”ëª¨ ëª©ë¡ ì—…ë°ì´íŠ¸
            updateMobileMemos(memos);
        }
    } catch (error) {
        console.error('ë©”ëª¨ ë¡œë“œ ì˜¤ë¥˜:', error);
        if (isDesktopMode) {
            displayMemos([]);
        } else {
            updateMobileMemos([]);
        }
    }
}

// ëª¨ë°”ì¼ ë©”ëª¨ ì—…ë°ì´íŠ¸
function updateMobileMemos(memos) {
    // í™”ë©´ í¬ê¸° ì²´í¬ - ëª¨ë°”ì¼ ëª¨ë“œê°€ ì•„ë‹ˆë©´ í•¨ìˆ˜ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if (window.innerWidth >= 1280) {
        console.log('ë°ìŠ¤í¬í†± ëª¨ë“œì—ì„œëŠ” updateMobileMemosë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    const mobileContainer = document.getElementById('mobile-memo-list');

    if (!mobileContainer) {
        console.log('ëª¨ë°”ì¼ ë©”ëª¨ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (memos.length === 0) {
        mobileContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p class="text-sm">ğŸ“</p>
                <p class="text-sm mt-2">ì•„ì§ ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-xs mt-1">ìœ„ì˜ ì…ë ¥ ì°½ì—ì„œ ì˜¤ëŠ˜ì˜ ì²« ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            </div>
        `;
        return;
    }

    mobileContainer.innerHTML = memos.map(memo => {
        const timeStr = memo.created_at ? new Date(memo.created_at).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }) : '';

        return `
            <div class="border-b border-gray-100 py-3 px-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-3">
                        <p class="text-sm text-gray-800 leading-relaxed">${escapeHtml(memo.content)}</p>
                        <p class="text-xs text-gray-400 mt-1">${timeStr}</p>
                    </div>
                    <div class="flex space-x-1">
                        <button class="mobile-edit-memo-btn text-gray-400 hover:text-blue-500 p-1 rounded"
                                data-memo-id="${memo.id}"
                                data-memo-content="${escapeHtml(memo.content)}"
                                title="ë©”ëª¨ ìˆ˜ì •">
                            âœï¸
                        </button>
                        <button class="mobile-delete-memo-btn text-gray-400 hover:text-red-500 p-1 rounded"
                                data-memo-id="${memo.id}"
                                title="ë©”ëª¨ ì‚­ì œ">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


// ë©”ëª¨ ëª©ë¡ í‘œì‹œ
function displayMemos(memos) {
    // í™”ë©´ í¬ê¸° ì²´í¬ - ë°ìŠ¤í¬í†± ëª¨ë“œê°€ ì•„ë‹ˆë©´ í•¨ìˆ˜ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if (window.innerWidth < 1280) {
        console.log('ëª¨ë°”ì¼ ëª¨ë“œì—ì„œëŠ” displayMemosë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    const memoList = document.getElementById('memo-list');
    const emptyState = document.getElementById('empty-memo-state');
    const memoCount = document.getElementById('memo-count');
    const clearAllBtn = document.getElementById('clear-all-memos');

    // ê° ìš”ì†Œë³„ë¡œ êµ¬ì²´ì ìœ¼ë¡œ í™•ì¸
    if (!memoList) {
        console.error('memo-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if (!emptyState) {
        console.error('empty-memo-state ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if (!memoCount) {
        console.error('memo-count ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if (!clearAllBtn) {
        console.error('clear-all-memos ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ë©”ëª¨ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    memoCount.textContent = memos.length;

    if (memos.length === 0) {
        emptyState.classList.remove('hidden');
        clearAllBtn.classList.add('hidden');
        memoList.innerHTML = '';
        memoList.appendChild(emptyState);
        return;
    }

    emptyState.classList.add('hidden');
    clearAllBtn.classList.remove('hidden');

    // ë©”ëª¨ ëª©ë¡ ìƒì„± (ìµœì‹ ìˆœ)
    const sortedMemos = memos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    // ê¸°ì¡´ ë©”ëª¨ë“¤ë§Œ ì œê±°í•˜ê³  empty-stateëŠ” ë³´ì¡´
    const existingMemos = memoList.querySelectorAll('.memo-item');
    existingMemos.forEach(memo => memo.remove());

    // ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ì— ìƒˆ ë©”ëª¨ë“¤ ì¶”ê°€
    const memosHtml = sortedMemos.map(memo => {
        const createdTime = new Date(memo.created_at).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        return `
            <div class="memo-item p-4 border-b last:border-b-0 hover:bg-gray-50" data-memo-id="${memo.id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 mr-3">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${escapeHtml(memo.content)}</p>
                        <div class="text-xs text-gray-500 mt-2">
                            ${createdTime}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button
                            class="desktop-edit-memo-btn text-gray-400 hover:text-blue-500 p-1 rounded"
                            data-memo-content="${escapeHtml(memo.content)}"                            data-memo-id="${memo.id}"
                            title="ë©”ëª¨ ìˆ˜ì •"
                        >
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                            </svg>
                        </button>
                        <button
                            
                            class="desktop-delete-memo-btn text-gray-400 hover:text-red-500 p-1 rounded" data-memo-id="${memo.id}"
                            title="ë©”ëª¨ ì‚­ì œ"
                        >
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ì— ìƒˆ ë©”ëª¨ë“¤ ì¶”ê°€ (empty-state ë’¤ì— ì¶”ê°€)
    if (memosHtml) {
        memoList.insertAdjacentHTML('beforeend', memosHtml);
    }
}

// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ë©”ëª¨ ì¶”ê°€
document.getElementById('add-memo-btn').addEventListener('click', async () => {
    const memoInput = document.getElementById('memo-input');
    const content = memoInput.value.trim();

    if (!content) {
        alert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        memoInput.focus();
        return;
    }

    try {
        if (currentEditingMemoId) {
            // ìˆ˜ì • ëª¨ë“œ
            await updateMemo(currentEditingMemoId, content);
            resetMemoInputMode();
        } else {
            // ì¶”ê°€ ëª¨ë“œ
            const formData = new FormData();
            formData.append('content', content);

            const response = await fetch('/api/daily/memos/quick', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('ë©”ëª¨ ì¶”ê°€ ì‹¤íŒ¨');
            }

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            memoInput.value = '';
            document.getElementById('memo-char-count').textContent = '0';
        }

        // ë©”ëª¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        const operation = currentEditingMemoId ? 'ìˆ˜ì •' : 'ì¶”ê°€';
        console.error(`ë©”ëª¨ ${operation} ì˜¤ë¥˜:`, error);
        alert(`ë©”ëª¨ ${operation} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
    }
});

// Enter í‚¤ë¡œ ë©”ëª¨ ì¶”ê°€/ìˆ˜ì •, ESC í‚¤ë¡œ ìˆ˜ì • ì·¨ì†Œ
document.getElementById('memo-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('add-memo-btn').click();
    } else if (e.key === 'Escape' && currentEditingMemoId) {
        e.preventDefault();
        resetMemoInputMode();
    }
});

// ë©”ëª¨ ì‚­ì œ
async function deleteMemo(memoId) {
    if (!confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`/api/daily/memos/${memoId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
        }

        // ë©”ëª¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë©”ëª¨ ìˆ˜ì •
// í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ë©”ëª¨ IDë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜
let currentEditingMemoId = null;

function editMemo(memoId, currentContent) {
    const memoInput = document.getElementById('memo-input');
    const addBtn = document.getElementById('add-memo-btn');
    const charCount = document.getElementById('memo-char-count');

    if (!memoInput || !addBtn || !charCount) {
        console.error('ë©”ëª¨ ì…ë ¥ ìš”ì†Œë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
    currentEditingMemoId = memoId;
    memoInput.value = currentContent;
    charCount.textContent = currentContent.length;

    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ ì¡°ì •
    addBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
    addBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium';

    // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
    memoInput.focus();

    // ì»¤ì„œë¥¼ í…ìŠ¤íŠ¸ ëìœ¼ë¡œ ì´ë™
    memoInput.setSelectionRange(memoInput.value.length, memoInput.value.length);
}

// ë©”ëª¨ ì…ë ¥ ëª¨ë“œë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
function resetMemoInputMode() {
    const memoInput = document.getElementById('memo-input');
    const addBtn = document.getElementById('add-memo-btn');
    const charCount = document.getElementById('memo-char-count');

    if (!memoInput || !addBtn || !charCount) {
        console.error('ë©”ëª¨ ì…ë ¥ ìš”ì†Œë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ìˆ˜ì • ëª¨ë“œ í•´ì œ
    currentEditingMemoId = null;

    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    memoInput.value = '';
    charCount.textContent = '0';

    // ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë³µì›
    addBtn.textContent = 'ë©”ëª¨ ì¶”ê°€';
    addBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium';
}

// ë©”ëª¨ ì—…ë°ì´íŠ¸
async function updateMemo(memoId, content) {
    try {
        const formData = new FormData();
        formData.append('content', content);

        const response = await fetch(`/api/daily/memos/${memoId}`, {
            method: 'PUT',
            body: formData
        });

        if (!response.ok) {
            throw new Error('ë©”ëª¨ ìˆ˜ì • ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('ë©”ëª¨ ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ë©”ëª¨ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì „ì²´ ë©”ëª¨ ì‚­ì œ
document.getElementById('clear-all-memos').addEventListener('click', async () => {
    if (!confirm('ì˜¤ëŠ˜ì˜ ëª¨ë“  ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    try {
        // ë¨¼ì € ì˜¤ëŠ˜ì˜ ë©”ëª¨ ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('ë©”ëª¨ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (memos.length === 0) {
            alert('ì‚­ì œí•  ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ê° ë©”ëª¨ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì‚­ì œ
        let deletedCount = 0;
        for (const memo of memos) {
            try {
                const deleteResponse = await fetch(`/api/daily/memos/${memo.id}`, {
                    method: 'DELETE'
                });
                if (deleteResponse.ok) {
                    deletedCount++;
                }
            } catch (deleteError) {
                console.error(`ë©”ëª¨ ${memo.id} ì‚­ì œ ì‹¤íŒ¨:`, deleteError);
            }
        }

        alert(`${deletedCount}ê°œì˜ ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // ë©”ëª¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('ì „ì²´ ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// === ëª¨ë°”ì¼ ë©”ëª¨ ê¸°ëŠ¥ ===
// ëª¨ë°”ì¼ ë©”ëª¨ í† ê¸€ ë²„íŠ¼ (null ì²´í¬ ì¶”ê°€)
const mobileToggleBtn = document.getElementById('mobile-memo-toggle');
if (mobileToggleBtn) {
    mobileToggleBtn.addEventListener('click', () => {
        const mobileModal = document.getElementById('mobile-memo-modal');
        if (mobileModal) {
            mobileModal.classList.remove('hidden');
            // ëª¨ë°”ì¼ì—ì„œ ë©”ëª¨ë¥¼ ì—´ ë•Œ ìµœì‹  ë©”ëª¨ ëª©ë¡ ë¡œë“œ
            loadMemosBasedOnScreenSize();
        }
    });
}

// ëª¨ë°”ì¼ ë©”ëª¨ ëª¨ë‹¬ ë‹«ê¸° (null ì²´í¬ ì¶”ê°€)
const closeMobileBtn = document.getElementById('close-mobile-memo');
if (closeMobileBtn) {
    closeMobileBtn.addEventListener('click', () => {
        const mobileModal = document.getElementById('mobile-memo-modal');
        if (mobileModal) {
            mobileModal.classList.add('hidden');
        }
    });
}

// ëª¨ë°”ì¼ ë©”ëª¨ ì…ë ¥ ê¸€ì ìˆ˜ ì¹´ìš´í„° (null ì²´í¬ ì¶”ê°€)
const mobileMemoInput = document.getElementById('mobile-memo-input');
const mobileMemoCounter = document.getElementById('mobile-memo-counter');

if (mobileMemoInput && mobileMemoCounter) {
    mobileMemoInput.addEventListener('input', () => {
    const length = mobileMemoInput.value.length;
    mobileMemoCounter.textContent = `${length}/500`;

    if (length > 500) {
        mobileMemoCounter.classList.add('text-red-500');
        mobileMemoCounter.classList.remove('text-gray-500');
    } else {
        mobileMemoCounter.classList.remove('text-red-500');
        mobileMemoCounter.classList.add('text-gray-500');
    }
    });
}

// ëª¨ë°”ì¼ ë©”ëª¨ ì¶”ê°€ (null ì²´í¬ ì¶”ê°€)
const addMobileMemoBtn = document.getElementById('add-mobile-memo');
if (addMobileMemoBtn && mobileMemoInput && mobileMemoCounter) {
    addMobileMemoBtn.addEventListener('click', async () => {
    const content = mobileMemoInput.value.trim();

    if (!content) {
        alert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    if (content.length > 500) {
        alert('ë©”ëª¨ëŠ” 500ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    try {
        const response = await fetch('/api/daily/memos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content
            })
        });

        if (!response.ok) {
            throw new Error('ë©”ëª¨ ì¶”ê°€ ì‹¤íŒ¨');
        }

        // ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
        mobileMemoInput.value = '';
        mobileMemoCounter.textContent = '0/500';

        // ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ë©”ëª¨ ëª©ë¡ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
        await loadMemosBasedOnScreenSize();

        // ê°„ë‹¨í•œ í”¼ë“œë°±
        const button = document.getElementById('add-mobile-memo');
        const originalText = button.textContent;
        button.textContent = 'âœ“ ì¶”ê°€ë¨';
        button.disabled = true;

        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 1000);

    } catch (error) {
        console.error('ëª¨ë°”ì¼ ë©”ëª¨ ì¶”ê°€ ì˜¤ë¥˜:', error);
        alert('ë©”ëª¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    });
}


// ë©”ëª¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë™ì  ìƒì„±ëœ ë²„íŠ¼ìš© - ë°ìŠ¤í¬í†±ê³¼ ëª¨ë°”ì¼ ê³µí†µ)
document.addEventListener('click', async function(e) {
    // ë°ìŠ¤í¬í†± ë©”ëª¨ í¸ì§‘ ë²„íŠ¼
    if (e.target.classList.contains('desktop-edit-memo-btn') || e.target.closest('.desktop-edit-memo-btn')) {
        const button = e.target.classList.contains('desktop-edit-memo-btn') ? e.target : e.target.closest('.desktop-edit-memo-btn');
        const memoId = button.dataset.memoId;
        const currentContent = button.dataset.memoContent;

        // HTML ì—”í‹°í‹° ë””ì½”ë”©
        const decodedContent = currentContent
            .replace(/&#39;/g, "'")
            .replace(/&quot;/g, '"')
            .replace(/&gt;/g, '>')
            .replace(/&lt;/g, '<')
            .replace(/&amp;/g, '&');

        // ìƒˆë¡œìš´ ì¸ë¼ì¸ í¸ì§‘ ë°©ì‹ ì‚¬ìš©
        editMemo(memoId, decodedContent);
    }

    // ë°ìŠ¤í¬í†± ë©”ëª¨ ì‚­ì œ ë²„íŠ¼
    if (e.target.classList.contains('desktop-delete-memo-btn') || e.target.closest('.desktop-delete-memo-btn')) {
        const button = e.target.classList.contains('desktop-delete-memo-btn') ? e.target : e.target.closest('.desktop-delete-memo-btn');
        const memoId = button.dataset.memoId;

        if (!confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
            }

            // ë°ìŠ¤í¬í†±ê³¼ ëª¨ë°”ì¼ ë©”ëª¨ ëª©ë¡ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('ë°ìŠ¤í¬í†± ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ëª¨ë°”ì¼ ë©”ëª¨ í¸ì§‘ ë²„íŠ¼
    if (e.target.classList.contains('mobile-edit-memo-btn')) {
        const memoId = e.target.dataset.memoId;
        const currentContent = e.target.dataset.memoContent;

        // HTML ì—”í‹°í‹° ë””ì½”ë”©
        const decodedContent = currentContent
            .replace(/&#39;/g, "'")
            .replace(/&quot;/g, '"')
            .replace(/&gt;/g, '>')
            .replace(/&lt;/g, '<')
            .replace(/&amp;/g, '&');

        const newContent = prompt('ë©”ëª¨ ìˆ˜ì •:', decodedContent);

        if (newContent === null) return; // ì·¨ì†Œ

        if (!newContent.trim()) {
            alert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (newContent.length > 500) {
            alert('ë©”ëª¨ëŠ” 500ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: newContent.trim()
                })
            });

            if (!response.ok) {
                throw new Error('ë©”ëª¨ ìˆ˜ì • ì‹¤íŒ¨');
            }

            // ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ë©”ëª¨ ëª©ë¡ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('ëª¨ë°”ì¼ ë©”ëª¨ ìˆ˜ì • ì˜¤ë¥˜:', error);
            alert('ë©”ëª¨ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ëª¨ë°”ì¼ ë©”ëª¨ ì‚­ì œ ë²„íŠ¼
    if (e.target.classList.contains('mobile-delete-memo-btn')) {
        const memoId = e.target.dataset.memoId;

        if (!confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('ë©”ëª¨ ì‚­ì œ ì‹¤íŒ¨');
            }

            // ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ë©”ëª¨ ëª©ë¡ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('ëª¨ë°”ì¼ ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
});

// ëª¨ë°”ì¼ ì „ì²´ ë©”ëª¨ ì‚­ì œ (null ì²´í¬ ì¶”ê°€)
const mobileClearAllBtn = document.getElementById('mobile-clear-all-memos');
if (mobileClearAllBtn) {
    mobileClearAllBtn.addEventListener('click', async () => {
    if (!confirm('ì˜¤ëŠ˜ì˜ ëª¨ë“  ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    try {
        // ë¨¼ì € ì˜¤ëŠ˜ì˜ ë©”ëª¨ ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('ë©”ëª¨ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (memos.length === 0) {
            alert('ì‚­ì œí•  ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ê° ë©”ëª¨ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì‚­ì œ
        let deletedCount = 0;
        for (const memo of memos) {
            try {
                const deleteResponse = await fetch(`/api/daily/memos/${memo.id}`, {
                    method: 'DELETE'
                });
                if (deleteResponse.ok) {
                    deletedCount++;
                }
            } catch (deleteError) {
                console.error(`ë©”ëª¨ ${memo.id} ì‚­ì œ ì‹¤íŒ¨:`, deleteError);
            }
        }

        alert(`${deletedCount}ê°œì˜ ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ë©”ëª¨ ëª©ë¡ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('ëª¨ë°”ì¼ ì „ì²´ ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});
}
</script>
</body>
</html>