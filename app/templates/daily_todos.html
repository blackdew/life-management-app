{% from 'partials/navigation.html' import sidebar_navigation, mobile_navigation %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_dev %}[DEV] {% endif %}Daily Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- 개발 환경 배너 -->
    {% if app_env == "dev" %}
    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 px-4 text-center font-semibold shadow-md">
        🚧 개발 환경 (DEV) - 포트 8000 | DB: {{ database_url.split('/')[-1] }}
    </div>
    {% endif %}

<div class="min-h-screen bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64 xl:mr-80 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">⚡ Daily Flow</h1>
                    <p class="text-sm sm:text-base text-gray-600">{{ today_date or "날짜 없음" }}</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- 메모 토글 버튼 (작은 화면에서만 표시) -->
                    <button
                        id="mobile-memo-toggle"
                        class="xl:hidden p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-md"
                        title="메모 보기"
                    >
                        📝
                    </button>
                    <div class="text-right">
                        <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-blue-600">{{ summary.completed }}/{{ summary.total }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">완료</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64 xl:mr-80">
        <!-- 빠른 할 일 추가 -->
        <div class="bg-white mt-6 p-4 sm:p-6 lg:p-8 rounded-lg shadow-sm border">
            <div class="flex flex-col sm:flex-row gap-3 mb-3">
                <input
                    type="text"
                    id="quick-todo-input"
                    placeholder="할 일을 입력하세요..."
                    class="flex-1 px-4 py-3 sm:py-2 text-base sm:text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    maxlength="200"
                />
                <div class="flex gap-2">
                    <button
                        id="detailed-todo-btn"
                        type="button"
                        class="px-4 py-3 sm:py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-xs lg:text-sm font-medium"
                        title="상세 입력"
                    >
                        <span class="hidden sm:inline">상세 </span>⚙️
                    </button>
                    <button
                        id="quick-add-btn"
                        type="button"
                        class="px-6 py-3 sm:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 min-w-[80px] sm:min-w-[60px] text-sm font-medium"
                    >
                        추가
                    </button>
                </div>
            </div>

            <!-- 상세 입력 폼 (숨김) -->
            <div id="detailed-form" class="hidden mt-4 p-4 sm:p-6 bg-gray-50 rounded-lg border">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">상세 내용</label>
                        <textarea
                            id="todo-description"
                            placeholder="할 일에 대한 상세한 설명을 입력하세요..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">카테고리</label>
                            <select id="category-select" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                                <option value="기타">기타</option>
                                <option value="업무">업무</option>
                                <option value="개인">개인</option>
                                <option value="학습">학습</option>
                                <option value="건강">건강</option>
                                <option value="관계">관계</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">예상 소요시간 (분)</label>
                            <input
                                type="number"
                                id="estimated-minutes"
                                placeholder="30"
                                min="1"
                                max="480"
                                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                            />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">여정</label>
                        <select id="journey-select" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">여정 선택 (선택사항)</option>
                            <!-- 여정 목록은 JavaScript로 로드 -->
                        </select>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 mt-2">
                        <button
                            id="detailed-add-btn"
                            type="button"
                            class="flex-1 px-4 py-3 sm:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            상세 추가
                        </button>
                        <button
                            id="cancel-detailed-btn"
                            type="button"
                            class="px-4 py-3 sm:py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm"
                        >
                            취소
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 진행 상황 -->
        {% if summary.total > 0 %}
        <div class="mt-6">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm sm:text-base font-medium text-gray-700">오늘의 진행상황</span>
                    <span class="text-sm sm:text-base text-gray-500">{{ summary.completion_rate }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 sm:h-4">
                    <div
                        class="bg-blue-600 h-3 sm:h-4 rounded-full transition-all duration-300"
                        style="width: {{ summary.completion_rate }}%"
                    ></div>
                </div>
                <div class="flex justify-between items-end mt-3">
                    <div class="text-xs sm:text-sm text-gray-600">
                        <span>완료: {{ summary.completed }}개</span>
                        <span class="ml-4">남은 일: {{ summary.pending }}개</span>
                    </div>
                    <button
                        id="daily-reflection-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium"
                        title="오늘 하루 마감하기"
                    >
                        📔 하루 마감
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 할일 목록 (기존 영역 유지) -->
        <div class="mt-6 mb-20 lg:mb-8">
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">📋</span>오늘의 할일
                </h2>
                    <div id="todos-container" class="space-y-4">
                {% if today_todos %}
                    {% for todo in today_todos %}
                    <div class="todo-item
                        {% if todo.overdue_status == 'overdue' and not todo.is_completed %}
                            bg-red-50 border-red-200
                        {% elif todo.overdue_status == 'scheduled' %}
                            bg-yellow-50 border-yellow-200
                        {% else %}
                            bg-white border
                        {% endif %}
                        rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200" data-todo-id="{{ todo.id }}">
                        <div class="p-4 sm:p-5">
                            <div class="flex items-start">
                                <!-- 체크박스 -->
                                <button
                                    class="todo-checkbox mr-3 sm:mr-4 p-1 mt-0.5"
                                    data-todo-id="{{ todo.id }}"
                                    aria-label="할 일 완료 토글"
                                >
                                    {% if todo.is_completed %}
                                    <div class="w-6 h-6 sm:w-7 sm:h-7 bg-green-500 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    {% else %}
                                    <div class="w-6 h-6 sm:w-7 sm:h-7 border-2 border-gray-300 rounded-full hover:border-blue-500 transition-colors"></div>
                                    {% endif %}
                                </button>

                                <!-- 할 일 내용 -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm sm:text-base lg:text-lg font-medium text-gray-900 {{ 'line-through text-gray-500' if todo.is_completed else '' }}">
                                        {{ todo.title }}
                                    </h3>

                                    {% if todo.description %}
                                    <p class="text-xs sm:text-sm text-gray-600 mt-2 {{ 'line-through' if todo.is_completed else '' }}">{{ todo.description }}</p>
                                    {% endif %}

                                    <div class="flex flex-wrap gap-2 mt-3">
                                        {% if todo.journey %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-purple-100 text-purple-600 rounded-full">
                                            🎯 {{ todo.journey.title }}
                                        </span>
                                        {% endif %}

                                        {% if todo.category and todo.category != "기타" %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-blue-100 text-blue-600 rounded-full">
                                            🏷️ {{ todo.category }}
                                        </span>
                                        {% endif %}

                                        {% if todo.estimated_minutes %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-gray-100 text-gray-600 rounded-full">
                                            ⏱️ {{ todo.estimated_minutes }}분
                                        </span>
                                        {% endif %}

                                        <!-- 경과일 배지 추가 -->
                                        {% if todo.overdue_text %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm
                                            {% if todo.overdue_status == 'overdue' %}bg-red-100 text-red-600{% endif %}
                                            {% if todo.overdue_status == 'today' %}bg-green-100 text-green-600{% endif %}
                                            {% if todo.overdue_status == 'scheduled' %}bg-yellow-100 text-yellow-600{% endif %}
                                            rounded-full">
                                            {% if todo.overdue_status == 'overdue' %}⚠️ {{ todo.overdue_text }}{% endif %}
                                            {% if todo.overdue_status == 'today' %}📅 오늘{% endif %}
                                            {% if todo.overdue_status == 'scheduled' %}⏳ 예정{% endif %}
                                        </span>
                                        {% endif %}

                                        <!-- 미루기 횟수 배지 -->
                                        {% if todo.postpone_count and todo.postpone_count > 0 %}
                                        <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm bg-orange-100 text-orange-600 rounded-full cursor-pointer"
                                              onclick="showPostponeHistory({{ todo.id }})"
                                              title="미루기 히스토리 보기">
                                            🔄 {{ todo.postpone_count }}번 미룸
                                        </span>
                                        {% endif %}
                                    </div>

                                    {% if todo.completion_reflection or todo.completion_image_path %}
                                    <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-md relative">
                                        <!-- 회고 수정 버튼 -->
                                        <button
                                            class="edit-reflection absolute top-2 right-2 p-1.5 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-md transition-colors"
                                            data-todo-id="{{ todo.id }}"
                                            data-reflection="{{ (todo.completion_reflection or '')|e }}"
                                            data-image-path="{{ (todo.completion_image_path or '')|e }}"
                                            title="회고 수정"
                                            aria-label="회고 수정"
                                        >
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                            </svg>
                                        </button>
                                        {% if todo.completion_reflection %}
                                        <p class="text-xs sm:text-sm text-green-700 whitespace-pre-wrap pr-8"><span class="font-medium">회고:</span>{{- todo.completion_reflection.replace('\r\n', '\n').replace('\r', '\n').lstrip() -}}</p>
                                        {% endif %}
                                        {% if todo.completion_image_path %}
                                        <div class="mt-2">
                                            <img src="{{ todo.completion_image_path }}"
                                                 alt="완료 회고 이미지"
                                                 class="max-w-full max-h-32 sm:max-h-48 rounded cursor-pointer hover:opacity-80 transition-opacity"
                                                 onclick="showImageModal('{{ todo.completion_image_path }}')" />
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- 액션 버튼들 -->
                                <div class="ml-2 sm:ml-3 flex gap-1 sm:gap-2">
                                    {% if not todo.is_completed %}
                                    <!-- 편집 버튼 -->
                                    <button
                                        class="edit-todo p-2 sm:p-2.5 text-gray-400 hover:text-blue-500 transition-colors rounded-md hover:bg-blue-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="할 일 편집"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                        </svg>
                                    </button>

                                    <!-- 미루기 버튼 -->
                                    <button
                                        class="reschedule-todo p-2 sm:p-2.5 text-gray-400 hover:text-yellow-500 transition-colors rounded-md hover:bg-yellow-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="할 일 미루기"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    {% endif %}

                                    <!-- 삭제 버튼 -->
                                    <button
                                        class="todo-delete p-2 sm:p-2.5 text-gray-400 hover:text-red-500 transition-colors rounded-md hover:bg-red-50"
                                        data-todo-id="{{ todo.id }}"
                                        aria-label="할 일 삭제"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-16 sm:py-20">
                        <div class="text-6xl sm:text-8xl mb-6">🌱</div>
                        <h3 class="text-lg sm:text-xl lg:text-2xl font-medium text-gray-900 mb-3">아직 할 일이 없네요!</h3>
                        <p class="text-gray-500 text-sm sm:text-base">위의 입력창에서 오늘의 첫 할 일을 추가해보세요.</p>
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    {{ mobile_navigation('daily_todos') }}

    {{ sidebar_navigation('daily_todos') }}

    <!-- 우측 고정 메모 패널 (큰 화면에서만 표시) -->
    <div class="hidden xl:block fixed top-0 right-0 w-80 h-full bg-white shadow-lg border-l z-30">
        <div class="flex flex-col h-full">
            <!-- 메모 패널 헤더 -->
            <div class="p-4 border-b bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">📝</span>오늘의 메모
                </h2>
            </div>

            <!-- 메모 입력 영역 -->
            <div class="p-4 border-b">
                <div class="space-y-3">
                    <textarea
                        id="memo-input"
                        placeholder="오늘 기억하고 싶은 것들을 자유롭게 적어보세요..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            <span id="memo-char-count">0</span>/500자
                        </span>
                        <button
                            id="add-memo-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            메모 추가
                        </button>
                    </div>
                </div>
            </div>

            <!-- 메모 목록 영역 -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">
                            작성한 메모 <span id="memo-count" class="text-blue-600">0</span>개
                        </h3>
                        <button
                            id="clear-all-memos"
                            class="text-xs text-red-600 hover:text-red-800 hidden"
                        >
                            전체 삭제
                        </button>
                    </div>
                </div>

                <!-- 메모 리스트 (스크롤 가능) -->
                <div id="memo-list" class="flex-1 overflow-y-auto">
                    <div id="empty-memo-state" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">📝</div>
                        <p class="text-sm">아직 작성한 메모가 없습니다</p>
                        <p class="text-xs text-gray-400 mt-1">위에서 메모를 추가해보세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 완료 시 회고 모달 -->
<div id="reflection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md lg:max-w-lg">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-4">완료 회고</h3>
            <p class="text-sm sm:text-base text-gray-600 mb-6">
                이 할 일을 완료하며 어떤 점이 좋았나요? 배운 점이나 느낀 점을 기록해보세요.
            </p>
            <textarea
                id="reflection-text"
                placeholder="회고를 입력하세요... (선택사항)"
                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                rows="4"
            ></textarea>

            <!-- 이미지 업로드 섹션 -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    📷 이미지 추가 (선택사항)
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors">
                    <input
                        type="file"
                        id="reflection-image"
                        accept="image/*"
                        class="hidden"
                        onchange="handleImagePreview(this)"
                    />
                    <label for="reflection-image" class="cursor-pointer">
                        <div id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">클릭하여 이미지 선택</p>
                            <p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF, WebP (최대 10MB)</p>
                        </div>
                        <div id="image-preview" class="hidden">
                            <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded" />
                            <p class="text-xs text-gray-500 mt-2" id="image-name"></p>
                        </div>
                    </label>
                    <button
                        type="button"
                        id="remove-image"
                        class="hidden mt-2 text-xs text-red-600 hover:text-red-800"
                        onclick="removeImagePreview()"
                    >
                        이미지 제거
                    </button>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="complete-with-reflection"
                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base font-medium"
                >
                    완료
                </button>
                <button
                    id="cancel-reflection"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 회고 수정 모달 -->
<div id="edit-reflection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md lg:max-w-lg">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-4">완료 회고 수정</h3>
            <p class="text-sm sm:text-base text-gray-600 mb-6">
                작성한 회고를 수정하거나 삭제할 수 있습니다.
            </p>
            <textarea
                id="edit-reflection-text"
                placeholder="회고를 입력하세요..."
                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                rows="4"
            ></textarea>

            <!-- 이미지 업로드 섹션 -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    📷 이미지 추가 (선택사항)
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors">
                    <input
                        type="file"
                        id="edit-reflection-image"
                        accept="image/*"
                        class="hidden"
                        onchange="handleEditImagePreview(this)"
                    />
                    <label for="edit-reflection-image" class="cursor-pointer">
                        <div id="edit-image-upload-area">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">클릭하여 이미지 선택</p>
                            <p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF, WebP (최대 10MB)</p>
                        </div>
                        <div id="edit-image-preview" class="hidden">
                            <img id="edit-preview-img" class="max-w-full max-h-32 mx-auto rounded" />
                            <p class="text-xs text-gray-500 mt-2" id="edit-image-name"></p>
                        </div>
                    </label>
                    <button
                        type="button"
                        id="edit-remove-image"
                        class="hidden mt-2 text-xs text-red-600 hover:text-red-800"
                        onclick="removeEditImagePreview()"
                    >
                        이미지 제거
                    </button>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="update-reflection"
                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base font-medium"
                >
                    수정 완료
                </button>
                <button
                    id="cancel-edit-reflection"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 미루기 모달 -->
<div id="reschedule-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-4">일정 변경</h3>
            <p class="text-sm sm:text-base text-gray-600 mb-4">
                언제로 미루시겠습니까?
            </p>
            <input
                type="date"
                id="reschedule-date"
                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base mb-4"
            />

            <div class="mb-6">
                <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">미루기 사유 *</label>
                <input
                    type="text"
                    id="reschedule-reason"
                    placeholder="예: 회의가 늦게 끝남, 컨디션이 안 좋음..."
                    maxlength="100"
                    class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                    required
                />
                <p class="text-xs text-gray-500 mt-1">최대 100자까지 입력 가능</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
                <button
                    id="confirm-reschedule"
                    class="flex-1 px-6 py-3 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm sm:text-base font-medium"
                >
                    미루기
                </button>
                <button
                    id="cancel-reschedule"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 편집 모달 -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm sm:max-w-md lg:max-w-lg">
            <h3 class="text-lg sm:text-xl font-medium text-gray-900 mb-6">할 일 편집</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">제목</label>
                    <input
                        type="text"
                        id="edit-title"
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                    />
                </div>
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">상세 내용</label>
                    <textarea
                        id="edit-description"
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                        rows="3"
                    ></textarea>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">카테고리</label>
                            <select id="edit-category" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                                <option value="기타">기타</option>
                                <option value="업무">업무</option>
                                <option value="개인">개인</option>
                                <option value="학습">학습</option>
                                <option value="건강">건강</option>
                                <option value="관계">관계</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">예상 소요시간 (분)</label>
                            <input
                                type="number"
                                id="edit-estimated-minutes"
                                min="1"
                                max="480"
                                class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base"
                            />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">여정</label>
                        <select id="edit-journey" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">여정 선택 (선택사항)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="save-edit"
                    class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm sm:text-base font-medium"
                >
                    저장
                </button>
                <button
                    id="cancel-edit"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 일일 회고 모달 -->
<div id="daily-reflection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg sm:text-xl font-medium text-gray-900">📔 오늘 하루 회고</h3>
                <button id="close-daily-reflection" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- 오늘의 성과 요약 -->
            <div id="today-summary" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-lg font-medium text-gray-900 mb-3">📊 오늘의 성과</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div id="modal-total-todos" class="text-2xl font-bold text-blue-600">-</div>
                        <div class="text-sm text-gray-500">전체 할 일</div>
                    </div>
                    <div>
                        <div id="modal-completed-todos" class="text-2xl font-bold text-green-600">-</div>
                        <div class="text-sm text-gray-500">완료</div>
                    </div>
                    <div>
                        <div id="modal-completion-rate" class="text-2xl font-bold text-purple-600">-%</div>
                        <div class="text-sm text-gray-500">완료율</div>
                    </div>
                </div>
            </div>

            <!-- 완료/미완료 할 일 목록 -->
            <div id="todo-breakdown" class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 완료한 일들 -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h5 class="font-medium text-green-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            완료한 일들
                        </h5>
                        <div id="completed-list" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>

                    <!-- 미완료 일들 -->
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h5 class="font-medium text-orange-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            미완료 일들
                        </h5>
                        <div id="pending-list" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm sm:text-base font-medium text-gray-700">회고 내용</label>
                        <button type="button" id="load-template" class="text-sm text-blue-600 hover:text-blue-800">
                            📝 템플릿 불러오기
                        </button>
                    </div>
                    <textarea
                        id="daily-reflection-text"
                        placeholder="오늘 하루를 돌아보며... 어떤 점이 좋았고, 무엇을 배웠으며, 내일은 어떻게 하고 싶은지 자유롭게 적어보세요."
                        class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base resize-none"
                        rows="8"
                        required
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">만족도</label>
                        <select id="satisfaction-score" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">선택하세요</option>
                            <option value="5">⭐⭐⭐⭐⭐ 매우 만족</option>
                            <option value="4">⭐⭐⭐⭐ 만족</option>
                            <option value="3">⭐⭐⭐ 보통</option>
                            <option value="2">⭐⭐ 아쉬움</option>
                            <option value="1">⭐ 매우 아쉬움</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm sm:text-base font-medium text-gray-700 mb-2">에너지 레벨</label>
                        <select id="energy-level" class="w-full px-4 py-3 border border-gray-300 rounded-md text-sm sm:text-base">
                            <option value="">선택하세요</option>
                            <option value="5">⚡ 매우 활기참</option>
                            <option value="4">🔋 활기참</option>
                            <option value="3">🔋 보통</option>
                            <option value="2">🔋 약간 피곤</option>
                            <option value="1">🪫 매우 피곤</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button
                    id="save-daily-reflection"
                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base font-medium"
                >
                    💾 회고 저장하기
                </button>
                <button
                    id="cancel-daily-reflection"
                    class="px-6 py-3 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm sm:text-base"
                >
                    취소
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 미루기 히스토리 모달 -->
<div id="postpone-history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg sm:text-xl font-medium text-gray-900">🔄 미루기 히스토리</h3>
                <button id="close-postpone-history" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="postpone-summary" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="text-md font-medium text-gray-900 mb-3">📊 요약</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="text-gray-500">총 미루기 횟수</div>
                        <div id="summary-postpone-count" class="text-lg font-bold text-orange-600">-</div>
                    </div>
                    <div>
                        <div class="text-gray-500">총 지연 일수</div>
                        <div id="summary-total-days" class="text-lg font-bold text-red-600">-일</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="text-gray-500">처음 등록일</div>
                    <div id="summary-original-date" class="text-sm font-medium">-</div>
                </div>
            </div>

            <div id="postpone-history-list" class="space-y-3">
                <!-- 히스토리 항목들이 여기에 동적으로 추가됩니다 -->
            </div>

            <div class="flex justify-center mt-6">
                <button
                    id="close-postpone-history-btn"
                    class="px-6 py-2 border border-gray-300 text-gray-600 rounded-md hover:bg-gray-50 text-sm"
                >
                    닫기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 이미지 확대 보기 모달 -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
        <button
            onclick="closeImageModal()"
            class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl z-10"
        >
            ✕
        </button>
        <img id="modal-image" class="max-w-full max-h-full rounded-lg" />
    </div>
</div>

<!-- 모바일 메모 모달 -->
<div id="mobile-memo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden xl:hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[80vh] flex flex-col">
            <!-- 모달 헤더 -->
            <div class="p-4 border-b bg-gray-50 rounded-t-lg">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <span class="mr-2">📝</span>오늘의 메모
                    </h2>
                    <button
                        id="close-mobile-memo"
                        class="p-2 text-gray-400 hover:text-gray-600"
                    >
                        ✕
                    </button>
                </div>
            </div>

            <!-- 메모 입력 영역 -->
            <div class="p-4 border-b">
                <div class="space-y-3">
                    <textarea
                        id="mobile-memo-input"
                        placeholder="오늘 기억하고 싶은 것들을 자유롭게 적어보세요..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            <span id="mobile-memo-char-count">0</span>/500자
                        </span>
                        <button
                            id="mobile-add-memo-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
                        >
                            메모 추가
                        </button>
                    </div>
                </div>
            </div>

            <!-- 메모 목록 영역 -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-700">
                            작성한 메모 <span id="mobile-memo-count" class="text-blue-600">0</span>개
                        </h3>
                        <button
                            id="mobile-clear-all-memos"
                            class="text-xs text-red-600 hover:text-red-800 hidden"
                        >
                            전체 삭제
                        </button>
                    </div>
                </div>

                <!-- 메모 리스트 (스크롤 가능) -->
                <div id="mobile-memo-list" class="flex-1 overflow-y-auto">
                    <div id="mobile-empty-memo-state" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">📝</div>
                        <p class="text-sm">아직 작성한 메모가 없습니다</p>
                        <p class="text-xs text-gray-400 mt-1">위에서 메모를 추가해보세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentTodoId = null;

// 페이지 로드 시 여정 목록 로드
document.addEventListener('DOMContentLoaded', async () => {
    await loadMilestones();
});

// 여정 목록 로드
async function loadMilestones() {
    try {
        const response = await fetch('/api/daily/journeys');
        if (response.ok) {
            const data = await response.json();
            const select = document.getElementById('journey-select');

            // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // 여정 옵션 추가
            data.journeys.forEach(journey => {
                const option = document.createElement('option');
                option.value = journey.id;
                option.textContent = journey.title;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('여정 로드 실패:', error);
    }
}

// 상세 입력 폼 토글
document.getElementById('detailed-todo-btn').addEventListener('click', () => {
    const form = document.getElementById('detailed-form');
    const isHidden = form.classList.contains('hidden');

    if (isHidden) {
        form.classList.remove('hidden');
        document.getElementById('detailed-todo-btn').textContent = '📝';
    } else {
        form.classList.add('hidden');
        document.getElementById('detailed-todo-btn').textContent = '⚙️';
        clearDetailedForm();
    }
});

// 상세 입력 폼 취소
document.getElementById('cancel-detailed-btn').addEventListener('click', () => {
    document.getElementById('detailed-form').classList.add('hidden');
    document.getElementById('detailed-todo-btn').textContent = '⚙️';
    clearDetailedForm();
});

// 상세 입력 폼 초기화
function clearDetailedForm() {
    document.getElementById('todo-description').value = '';
    document.getElementById('journey-select').value = '';
    document.getElementById('category-select').value = '기타';
    document.getElementById('estimated-minutes').value = '';
}

// 빠른 할 일 추가
document.getElementById('quick-add-btn').addEventListener('click', async () => {
    const title = document.getElementById('quick-todo-input').value.trim();
    if (!title) return;

    try {
        const formData = new FormData();
        formData.append('title', title);

        const response = await fetch('/api/daily/todos/quick', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            document.getElementById('quick-todo-input').value = '';
            location.reload();
        } else {
            alert('할 일 추가에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
});

// 상세 할 일 추가
document.getElementById('detailed-add-btn').addEventListener('click', async () => {
    const title = document.getElementById('quick-todo-input').value.trim();
    if (!title) {
        alert('할 일 제목을 입력해주세요.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('title', title);

        const description = document.getElementById('todo-description').value.trim();
        if (description) {
            formData.append('description', description);
        }

        const category = document.getElementById('category-select').value || '기타';
        formData.append('category', category);

        const journeyId = document.getElementById('journey-select').value;
        if (journeyId) {
            formData.append('journey_id', journeyId);
        }

        const estimatedMinutes = document.getElementById('estimated-minutes').value.trim();
        if (estimatedMinutes && estimatedMinutes !== '') {
            formData.append('estimated_minutes', estimatedMinutes);
        }

        const response = await fetch('/api/daily/todos', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            document.getElementById('quick-todo-input').value = '';
            clearDetailedForm();
            document.getElementById('detailed-form').classList.add('hidden');
            document.getElementById('detailed-todo-btn').textContent = '⚙️';
            location.reload();
        } else {
            alert('할 일 추가에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
});

// 할 일 완료 토글 (회고 포함)
document.addEventListener('click', async (e) => {
    if (e.target.closest('.todo-checkbox')) {
        const button = e.target.closest('.todo-checkbox');
        const todoId = button.dataset.todoId;
        currentTodoId = todoId;

        try {
            // API에서 현재 상태 확인
            const response = await fetch(`/api/daily/todos/${todoId}`);
            const todo = await response.json();

            if (!todo.is_completed) {
                // 미완료 -> 완료: 회고 모달 표시
                document.getElementById('reflection-modal').classList.remove('hidden');
            } else {
                // 완료 -> 미완료: 바로 토글
                await toggleTodoComplete(todoId, null);
            }
        } catch (error) {
            console.error('할 일 상태 확인 실패:', error);
            // 에러 시 바로 토글
            await toggleTodoComplete(todoId, null);
        }
    }
});

// 회고와 함께 완료
document.getElementById('complete-with-reflection').addEventListener('click', async () => {
    const reflection = document.getElementById('reflection-text').value.trim();
    const imageFile = document.getElementById('reflection-image').files[0];
    await toggleTodoComplete(currentTodoId, reflection, imageFile);

    document.getElementById('reflection-modal').classList.add('hidden');
    document.getElementById('reflection-text').value = '';
    removeImagePreview();
    currentTodoId = null;
});

// 회고 모달 취소
document.getElementById('cancel-reflection').addEventListener('click', () => {
    document.getElementById('reflection-modal').classList.add('hidden');
    document.getElementById('reflection-text').value = '';
    removeImagePreview();
    currentTodoId = null;
});

// 할 일 완료 토글 함수
async function toggleTodoComplete(todoId, reflection, imageFile) {
    try {
        const formData = new FormData();
        if (reflection) {
            formData.append('reflection', reflection);
        }
        if (imageFile) {
            formData.append('reflection_image', imageFile);
        }

        const response = await fetch(`/api/daily/todos/${todoId}/complete`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('상태 변경에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
}

// 할 일 삭제
document.addEventListener('click', async (e) => {
    if (e.target.closest('.todo-delete')) {
        const button = e.target.closest('.todo-delete');
        const todoId = button.dataset.todoId;

        if (confirm('정말 삭제하시겠습니까?')) {
            try {
                const response = await fetch(`/api/daily/todos/${todoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            }
        }
    }
});

// 할 일 미루기
document.addEventListener('click', (e) => {
    if (e.target.closest('.reschedule-todo')) {
        const button = e.target.closest('.reschedule-todo');
        currentTodoId = button.dataset.todoId;

        // 내일 날짜를 기본값으로 설정
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('reschedule-date').value = tomorrow.toISOString().split('T')[0];

        document.getElementById('reschedule-modal').classList.remove('hidden');
    }
});

// 미루기 확인
document.getElementById('confirm-reschedule').addEventListener('click', async () => {
    const newDate = document.getElementById('reschedule-date').value;
    const reason = document.getElementById('reschedule-reason').value.trim();

    if (!newDate) {
        alert('날짜를 선택해주세요.');
        return;
    }

    if (!reason) {
        alert('미루기 사유를 입력해주세요.');
        return;
    }

    if (reason.length > 100) {
        alert('미루기 사유는 100자 이하로 입력해주세요.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('new_date', newDate);
        formData.append('reason', reason);

        const response = await fetch(`/api/daily/todos/${currentTodoId}/reschedule`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            document.getElementById('reschedule-modal').classList.add('hidden');
            // 모달 초기화
            document.getElementById('reschedule-reason').value = '';
            currentTodoId = null;
            location.reload();
        } else {
            const errorData = await response.json();
            alert(`일정 변경에 실패했습니다: ${errorData.detail || '알 수 없는 오류'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
});

// 미루기 모달 취소
document.getElementById('cancel-reschedule').addEventListener('click', () => {
    document.getElementById('reschedule-modal').classList.add('hidden');
    document.getElementById('reschedule-reason').value = '';
    currentTodoId = null;
});

// 할 일 편집
document.addEventListener('click', async (e) => {
    if (e.target.closest('.edit-todo')) {
        const button = e.target.closest('.edit-todo');
        currentTodoId = button.dataset.todoId;

        try {
            // API에서 할 일 정보 가져오기
            const response = await fetch(`/api/daily/todos/${currentTodoId}`);
            if (!response.ok) {
                throw new Error('할 일 정보를 가져올 수 없습니다.');
            }

            const todo = await response.json();

            // 폼에 데이터 채우기
            document.getElementById('edit-title').value = todo.title || '';
            document.getElementById('edit-description').value = todo.description || '';
            document.getElementById('edit-estimated-minutes').value = todo.estimated_minutes || '';

            // 카테고리 설정
            const categorySelect = document.getElementById('edit-category');
            // API에서 이미 한국어로 반환되므로 직접 설정
            categorySelect.value = todo.category;

            // 여정 설정
            const journeySelect = document.getElementById('edit-journey');
            journeySelect.value = todo.journey_id || '';

            document.getElementById('edit-modal').classList.remove('hidden');
        } catch (error) {
            console.error('할 일 정보 로드 실패:', error);
            alert('할 일 정보를 불러오는데 실패했습니다.');
        }
    }
});

// 편집 저장
document.getElementById('save-edit').addEventListener('click', async () => {
    const title = document.getElementById('edit-title').value.trim();
    if (!title) {
        alert('할 일 제목을 입력해주세요.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('title', title);

        const description = document.getElementById('edit-description').value.trim();
        if (description) {
            formData.append('description', description);
        }

        const category = document.getElementById('edit-category').value || '기타';
        formData.append('category', category);

        const estimatedMinutes = document.getElementById('edit-estimated-minutes').value.trim();
        if (estimatedMinutes && estimatedMinutes !== '') {
            formData.append('estimated_minutes', estimatedMinutes);
        }

        const journeyId = document.getElementById('edit-journey').value;
        if (journeyId) {
            formData.append('journey_id', journeyId);
        }

        const response = await fetch(`/api/daily/todos/${currentTodoId}`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            document.getElementById('edit-modal').classList.add('hidden');
            currentTodoId = null;
            location.reload();
        } else {
            alert('할 일 수정에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    }
});

// 편집 모달 취소
document.getElementById('cancel-edit').addEventListener('click', () => {
    document.getElementById('edit-modal').classList.add('hidden');
    currentTodoId = null;
});

// Enter 키로 할 일 추가
document.getElementById('quick-todo-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const detailedForm = document.getElementById('detailed-form');
        if (detailedForm.classList.contains('hidden')) {
            document.getElementById('quick-add-btn').click();
        } else {
            document.getElementById('detailed-add-btn').click();
        }
    }
});


// 일일 회고 모달 열기
document.getElementById('daily-reflection-btn').addEventListener('click', async () => {
    await loadReflectionData();
    document.getElementById('daily-reflection-modal').classList.remove('hidden');
});

// 회고 데이터 로드 함수
async function loadReflectionData() {
    try {
        const response = await fetch('/api/daily/reflection-summary');
        const data = await response.json();

        // 요약 정보 업데이트
        document.getElementById('modal-total-todos').textContent = data.summary.total || 0;
        document.getElementById('modal-completed-todos').textContent = data.summary.completed || 0;
        document.getElementById('modal-completion-rate').textContent = `${data.summary.completion_rate || 0}%`;

        // 완료한 일들 목록
        const completedList = document.getElementById('completed-list');
        completedList.innerHTML = '';

        if (data.completed_todos && Object.keys(data.completed_todos).length > 0) {
            Object.entries(data.completed_todos).forEach(([category, todos]) => {
                if (todos.length > 0) {
                    const categoryName = getCategoryName(category);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<div class="font-medium text-green-700 mb-1">${categoryName}</div>`;

                    todos.forEach(todo => {
                        const todoDiv = document.createElement('div');
                        const timeStr = todo.completed_at ? ` (${todo.completed_at})` : '';
                        todoDiv.className = 'text-gray-600 ml-2';
                        todoDiv.textContent = `• ${todo.title}${timeStr}`;
                        categoryDiv.appendChild(todoDiv);
                    });
                    completedList.appendChild(categoryDiv);
                }
            });
        } else {
            completedList.innerHTML = '<div class="text-gray-500 italic">완료한 일이 없습니다</div>';
        }

        // 미완료 일들 목록
        const pendingList = document.getElementById('pending-list');
        pendingList.innerHTML = '';

        if (data.pending_todos && Object.keys(data.pending_todos).length > 0) {
            Object.entries(data.pending_todos).forEach(([category, todos]) => {
                if (todos.length > 0) {
                    const categoryName = getCategoryName(category);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<div class="font-medium text-orange-700 mb-1">${categoryName}</div>`;

                    todos.forEach(todo => {
                        const todoDiv = document.createElement('div');
                        const timeStr = todo.estimated_minutes ? ` (예상 ${todo.estimated_minutes}분)` : '';
                        todoDiv.className = 'text-gray-600 ml-2';
                        todoDiv.textContent = `• ${todo.title}${timeStr}`;
                        categoryDiv.appendChild(todoDiv);
                    });
                    pendingList.appendChild(categoryDiv);
                }
            });
        } else {
            pendingList.innerHTML = '<div class="text-gray-500 italic">미완료 일이 없습니다</div>';
        }

        // 전역 변수에 템플릿 저장
        window.reflectionTemplate = data.reflection_template;

    } catch (error) {
        console.error('회고 데이터 로드 실패:', error);
        // 에러 시 기본값 설정
        document.getElementById('modal-total-todos').textContent = '0';
        document.getElementById('modal-completed-todos').textContent = '0';
        document.getElementById('modal-completion-rate').textContent = '0%';
    }
}

// 카테고리 이름 변환 함수
function getCategoryName(category) {
    const categoryNames = {
        'WORK': '💼 업무',
        'PERSONAL': '👤 개인',
        'HEALTH': '💪 건강',
        'LEARNING': '📚 학습',
        'SOCIAL': '👥 사회',
        'OTHER': '🔹 기타'
    };
    return categoryNames[category] || category;
}

// 템플릿 불러오기
document.getElementById('load-template').addEventListener('click', () => {
    if (window.reflectionTemplate) {
        document.getElementById('daily-reflection-text').value = window.reflectionTemplate;
    } else {
        alert('템플릿을 불러올 수 없습니다. 모달을 다시 열어주세요.');
    }
});

// 일일 회고 취소
document.getElementById('cancel-daily-reflection').addEventListener('click', () => {
    document.getElementById('daily-reflection-modal').classList.add('hidden');
    document.getElementById('daily-reflection-text').value = '';
    document.getElementById('satisfaction-score').value = '';
    document.getElementById('energy-level').value = '';
});

// X 버튼으로 닫기
document.getElementById('close-daily-reflection').addEventListener('click', () => {
    document.getElementById('daily-reflection-modal').classList.add('hidden');
    document.getElementById('daily-reflection-text').value = '';
    document.getElementById('satisfaction-score').value = '';
    document.getElementById('energy-level').value = '';
});

// 일일 회고 저장
document.getElementById('save-daily-reflection').addEventListener('click', async () => {
    const reflectionText = document.getElementById('daily-reflection-text').value.trim();
    const satisfactionScore = document.getElementById('satisfaction-score').value;
    const energyLevel = document.getElementById('energy-level').value;

    if (!reflectionText) {
        alert('회고 내용을 입력해주세요.');
        return;
    }

    try {
        const formData = new FormData();
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD 형식

        formData.append('reflection_date', today);
        formData.append('reflection_text', reflectionText);

        if (satisfactionScore) {
            formData.append('satisfaction_score', satisfactionScore);
        }
        if (energyLevel) {
            formData.append('energy_level', energyLevel);
        }

        const response = await fetch('/api/reflections/', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            document.getElementById('daily-reflection-modal').classList.add('hidden');
            document.getElementById('daily-reflection-text').value = '';
            document.getElementById('satisfaction-score').value = '';
            document.getElementById('energy-level').value = '';

            alert('📔 오늘의 회고가 저장되었습니다!\n\n회고 히스토리에서 확인하실 수 있습니다.');

            // 회고 히스토리 페이지로 이동할지 묻기
            if (confirm('회고 히스토리를 확인하시겠습니까?')) {
                window.location.href = '/reflection-history';
            }
        } else {
            const errorData = await response.json();
            alert(`회고 저장 중 오류가 발생했습니다: ${errorData.detail || '알 수 없는 오류'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('회고 저장 중 오류가 발생했습니다.');
    }
});

// 여정 목록 로드 함수
async function loadMilestones() {
    try {
        const response = await fetch('/api/daily/journeys');
        if (response.ok) {
            const data = await response.json();
            const journeys = data.journeys || [];

            // 추가 모달의 여정 드롭다운 업데이트
            const addMilestoneSelect = document.getElementById('journey-select');
            addMilestoneSelect.innerHTML = '<option value="">여정 선택 (선택사항)</option>';

            // 편집 모달의 여정 드롭다운 업데이트
            const editMilestoneSelect = document.getElementById('edit-journey');
            editMilestoneSelect.innerHTML = '<option value="">여정 선택 (선택사항)</option>';

            journeys.forEach(journey => {
                const option = document.createElement('option');
                option.value = journey.id;
                option.textContent = journey.title;

                addMilestoneSelect.appendChild(option.cloneNode(true));
                editMilestoneSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('여정 로드 실패:', error);
    }
}

// 이미지 미리보기 처리
function handleImagePreview(input) {
    const file = input.files[0];
    if (!file) return;

    // 파일 크기 체크 (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('이미지 파일 크기는 10MB 이하여야 합니다.');
        input.value = '';
        return;
    }

    // 파일 타입 체크
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('지원하지 않는 이미지 형식입니다. (JPG, PNG, GIF, WebP만 지원)');
        input.value = '';
        return;
    }

    // 미리보기 표시
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('image-upload-area').classList.add('hidden');
        document.getElementById('image-preview').classList.remove('hidden');
        document.getElementById('remove-image').classList.remove('hidden');

        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('image-name').textContent = file.name;
    };
    reader.readAsDataURL(file);
}

// 이미지 미리보기 제거
function removeImagePreview() {
    document.getElementById('reflection-image').value = '';
    document.getElementById('image-upload-area').classList.remove('hidden');
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('remove-image').classList.add('hidden');
    document.getElementById('preview-img').src = '';
    document.getElementById('image-name').textContent = '';
}

// === 회고 수정 관련 함수 ===

// 회고 수정 이미지 미리보기 처리
function handleEditImagePreview(input) {
    const file = input.files[0];
    if (!file) return;

    // 파일 크기 체크 (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('이미지 파일 크기는 10MB 이하여야 합니다.');
        input.value = '';
        return;
    }

    // 파일 타입 체크
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('지원하지 않는 이미지 형식입니다. (JPG, PNG, GIF, WebP만 지원)');
        input.value = '';
        return;
    }

    // 미리보기 표시
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('edit-image-upload-area').classList.add('hidden');
        document.getElementById('edit-image-preview').classList.remove('hidden');
        document.getElementById('edit-remove-image').classList.remove('hidden');

        document.getElementById('edit-preview-img').src = e.target.result;
        document.getElementById('edit-image-name').textContent = file.name;
    };
    reader.readAsDataURL(file);
}

// 회고 수정 이미지 미리보기 제거
function removeEditImagePreview() {
    document.getElementById('edit-reflection-image').value = '';
    document.getElementById('edit-image-upload-area').classList.remove('hidden');
    document.getElementById('edit-image-preview').classList.add('hidden');
    document.getElementById('edit-remove-image').classList.add('hidden');
    document.getElementById('edit-preview-img').src = '';
    document.getElementById('edit-image-name').textContent = '';
}

// 회고 수정 모달 열기
let currentEditTodoId = null;

document.addEventListener('click', (e) => {
    if (e.target.closest('.edit-reflection')) {
        const button = e.target.closest('.edit-reflection');
        currentEditTodoId = button.dataset.todoId;
        const reflection = button.dataset.reflection;
        const imagePath = button.dataset.imagePath;

        // 모달 열기
        document.getElementById('edit-reflection-modal').classList.remove('hidden');

        // 기존 회고 내용 채우기
        document.getElementById('edit-reflection-text').value = reflection || '';

        // 기존 이미지 표시 (있는 경우)
        if (imagePath) {
            document.getElementById('edit-image-upload-area').classList.add('hidden');
            document.getElementById('edit-image-preview').classList.remove('hidden');
            document.getElementById('edit-remove-image').classList.remove('hidden');
            document.getElementById('edit-preview-img').src = imagePath;
            document.getElementById('edit-image-name').textContent = '기존 이미지';
        } else {
            // 이미지 없으면 초기화
            removeEditImagePreview();
        }
    }
});

// 회고 수정 완료 버튼
document.getElementById('update-reflection').addEventListener('click', async () => {
    if (!currentEditTodoId) return;

    const reflection = document.getElementById('edit-reflection-text').value.trim();
    const imageFile = document.getElementById('edit-reflection-image').files[0];

    try {
        const formData = new FormData();
        formData.append('reflection', reflection);

        if (imageFile) {
            formData.append('reflection_image', imageFile);
        }

        const response = await fetch(`/api/daily/todos/${currentEditTodoId}/reflection`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            // 모달 닫기
            document.getElementById('edit-reflection-modal').classList.add('hidden');

            // 페이지 새로고침하여 변경사항 반영
            location.reload();
        } else {
            const error = await response.json();
            alert(error.detail || '회고 수정에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error updating reflection:', error);
        alert('회고 수정 중 오류가 발생했습니다.');
    }
});

// 회고 수정 취소 버튼
document.getElementById('cancel-edit-reflection').addEventListener('click', () => {
    document.getElementById('edit-reflection-modal').classList.add('hidden');
    currentEditTodoId = null;
    removeEditImagePreview();
});

// 모달 배경 클릭 시 닫기
document.addEventListener('click', (e) => {
    if (e.target.id === 'edit-reflection-modal') {
        document.getElementById('edit-reflection-modal').classList.add('hidden');
        currentEditTodoId = null;
        removeEditImagePreview();
    }
});

// === 회고 수정 관련 함수 끝 ===

// 이미지 모달 표시
function showImageModal(imagePath) {
    document.getElementById('modal-image').src = imagePath;
    document.getElementById('image-modal').classList.remove('hidden');
}

// 이미지 모달 닫기
function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('modal-image').src = '';
}

// ESC 키로 이미지 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// 미루기 히스토리 표시
async function showPostponeHistory(todoId) {
    try {
        const response = await fetch(`/api/daily/todos/${todoId}/postpone-summary`);
        if (!response.ok) {
            throw new Error('미루기 히스토리를 불러올 수 없습니다.');
        }

        const data = await response.json();

        // 요약 정보 업데이트
        document.getElementById('summary-postpone-count').textContent = data.postpone_count;
        document.getElementById('summary-total-days').textContent = `${data.total_days_postponed}일`;
        document.getElementById('summary-original-date').textContent = new Date(data.original_date).toLocaleDateString('ko-KR');

        // 히스토리 목록 생성
        const historyList = document.getElementById('postpone-history-list');
        historyList.innerHTML = '';

        if (data.full_history && data.full_history.length > 0) {
            data.full_history.forEach((history, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 border border-gray-200 rounded-md bg-gray-50';

                const fromDate = new Date(history.from_date).toLocaleDateString('ko-KR');
                const toDate = new Date(history.to_date).toLocaleDateString('ko-KR');
                const postponedAt = new Date(history.postponed_at).toLocaleString('ko-KR');

                historyItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">${index + 1}번째 미루기</span>
                        <span class="text-xs text-gray-500">${postponedAt}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="font-medium">${fromDate}</span> → <span class="font-medium">${toDate}</span>
                    </div>
                    <div class="text-sm text-gray-700 bg-white p-2 rounded border-l-4 border-orange-400">
                        💭 ${history.reason}
                    </div>
                `;

                historyList.appendChild(historyItem);
            });
        } else {
            historyList.innerHTML = '<div class="text-center text-gray-500 py-4">미루기 히스토리가 없습니다.</div>';
        }

        // 모달 표시
        document.getElementById('postpone-history-modal').classList.remove('hidden');

    } catch (error) {
        console.error('미루기 히스토리 로드 오류:', error);
        alert('미루기 히스토리를 불러오는 중 오류가 발생했습니다.');
    }
}

// 미루기 히스토리 모달 닫기
document.getElementById('close-postpone-history').addEventListener('click', () => {
    document.getElementById('postpone-history-modal').classList.add('hidden');
});

document.getElementById('close-postpone-history-btn').addEventListener('click', () => {
    document.getElementById('postpone-history-modal').classList.add('hidden');
});

// 모달 외부 클릭 시 닫기에 미루기 히스토리 모달 추가
document.addEventListener('click', (e) => {
    if (e.target.id === 'reflection-modal') {
        document.getElementById('cancel-reflection').click();
    }
    if (e.target.id === 'reschedule-modal') {
        document.getElementById('cancel-reschedule').click();
    }
    if (e.target.id === 'edit-modal') {
        document.getElementById('cancel-edit').click();
    }
    if (e.target.id === 'daily-reflection-modal') {
        document.getElementById('cancel-daily-reflection').click();
    }
    if (e.target.id === 'postpone-history-modal') {
        document.getElementById('close-postpone-history').click();
    }
});

// 페이지 로드 시 여정 목록 로드
document.addEventListener('DOMContentLoaded', () => {
    loadMilestones();
    loadMemosBasedOnScreenSize();
    setupMemoCharCounter();
});

// === 메모 관련 기능 ===

// 글자 수 카운터 설정
function setupMemoCharCounter() {
    const memoInput = document.getElementById('memo-input');
    const charCount = document.getElementById('memo-char-count');

    memoInput.addEventListener('input', () => {
        const currentLength = memoInput.value.length;
        charCount.textContent = currentLength;

        // 글자 수에 따른 스타일 변경
        if (currentLength > 450) {
            charCount.className = 'text-red-600';
        } else if (currentLength > 400) {
            charCount.className = 'text-yellow-600';
        } else {
            charCount.className = 'text-gray-500';
        }
    });
}

// 화면 크기에 따라 적절한 메모 로딩 함수를 호출하는 헬퍼 함수
async function loadMemosBasedOnScreenSize() {
    const isDesktopMode = window.innerWidth >= 1280; // xl breakpoint

    try {
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('메모 로드 실패');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (isDesktopMode) {
            // 데스크톱 메모 패널 업데이트
            displayMemos(memos);
        } else {
            // 모바일 메모 목록 업데이트
            updateMobileMemos(memos);
        }
    } catch (error) {
        console.error('메모 로드 오류:', error);
        if (isDesktopMode) {
            displayMemos([]);
        } else {
            updateMobileMemos([]);
        }
    }
}

// 모바일 메모 업데이트
function updateMobileMemos(memos) {
    // 화면 크기 체크 - 모바일 모드가 아니면 함수 실행하지 않음
    if (window.innerWidth >= 1280) {
        console.log('데스크톱 모드에서는 updateMobileMemos를 실행하지 않습니다.');
        return;
    }

    const mobileContainer = document.getElementById('mobile-memo-list');

    if (!mobileContainer) {
        console.log('모바일 메모 컨테이너를 찾을 수 없습니다.');
        return;
    }

    if (memos.length === 0) {
        mobileContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p class="text-sm">📝</p>
                <p class="text-sm mt-2">아직 작성된 메모가 없습니다.</p>
                <p class="text-xs mt-1">위의 입력 창에서 오늘의 첫 메모를 작성해보세요!</p>
            </div>
        `;
        return;
    }

    mobileContainer.innerHTML = memos.map(memo => {
        const timeStr = memo.created_at ? new Date(memo.created_at).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }) : '';

        return `
            <div class="border-b border-gray-100 py-3 px-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-3">
                        <p class="text-sm text-gray-800 leading-relaxed">${escapeHtml(memo.content)}</p>
                        <p class="text-xs text-gray-400 mt-1">${timeStr}</p>
                    </div>
                    <div class="flex space-x-1">
                        <button class="mobile-edit-memo-btn text-gray-400 hover:text-blue-500 p-1 rounded"
                                data-memo-id="${memo.id}"
                                data-memo-content="${escapeHtml(memo.content)}"
                                title="메모 수정">
                            ✏️
                        </button>
                        <button class="mobile-delete-memo-btn text-gray-400 hover:text-red-500 p-1 rounded"
                                data-memo-id="${memo.id}"
                                title="메모 삭제">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


// 메모 목록 표시
function displayMemos(memos) {
    // 화면 크기 체크 - 데스크톱 모드가 아니면 함수 실행하지 않음
    if (window.innerWidth < 1280) {
        console.log('모바일 모드에서는 displayMemos를 실행하지 않습니다.');
        return;
    }

    const memoList = document.getElementById('memo-list');
    const emptyState = document.getElementById('empty-memo-state');
    const memoCount = document.getElementById('memo-count');
    const clearAllBtn = document.getElementById('clear-all-memos');

    // 각 요소별로 구체적으로 확인
    if (!memoList) {
        console.error('memo-list 요소를 찾을 수 없습니다.');
        return;
    }
    if (!emptyState) {
        console.error('empty-memo-state 요소를 찾을 수 없습니다.');
        return;
    }
    if (!memoCount) {
        console.error('memo-count 요소를 찾을 수 없습니다.');
        return;
    }
    if (!clearAllBtn) {
        console.error('clear-all-memos 요소를 찾을 수 없습니다.');
        return;
    }

    // 메모 개수 업데이트
    memoCount.textContent = memos.length;

    if (memos.length === 0) {
        emptyState.classList.remove('hidden');
        clearAllBtn.classList.add('hidden');
        memoList.innerHTML = '';
        memoList.appendChild(emptyState);
        return;
    }

    emptyState.classList.add('hidden');
    clearAllBtn.classList.remove('hidden');

    // 메모 목록 생성 (최신순)
    const sortedMemos = memos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    // 기존 메모들만 제거하고 empty-state는 보존
    const existingMemos = memoList.querySelectorAll('.memo-item');
    existingMemos.forEach(memo => memo.remove());

    // 메모 리스트에 새 메모들 추가
    const memosHtml = sortedMemos.map(memo => {
        const createdTime = new Date(memo.created_at).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        return `
            <div class="memo-item p-4 border-b last:border-b-0 hover:bg-gray-50" data-memo-id="${memo.id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 mr-3">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${escapeHtml(memo.content)}</p>
                        <div class="text-xs text-gray-500 mt-2">
                            ${createdTime}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button
                            class="desktop-edit-memo-btn text-gray-400 hover:text-blue-500 p-1 rounded"
                            data-memo-content="${escapeHtml(memo.content)}"                            data-memo-id="${memo.id}"
                            title="메모 수정"
                        >
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                            </svg>
                        </button>
                        <button
                            
                            class="desktop-delete-memo-btn text-gray-400 hover:text-red-500 p-1 rounded" data-memo-id="${memo.id}"
                            title="메모 삭제"
                        >
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // 메모 리스트에 새 메모들 추가 (empty-state 뒤에 추가)
    if (memosHtml) {
        memoList.insertAdjacentHTML('beforeend', memosHtml);
    }
}

// HTML 이스케이프 함수
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 메모 추가
document.getElementById('add-memo-btn').addEventListener('click', async () => {
    const memoInput = document.getElementById('memo-input');
    const content = memoInput.value.trim();

    if (!content) {
        alert('메모 내용을 입력해주세요.');
        memoInput.focus();
        return;
    }

    try {
        if (currentEditingMemoId) {
            // 수정 모드
            await updateMemo(currentEditingMemoId, content);
            resetMemoInputMode();
        } else {
            // 추가 모드
            const formData = new FormData();
            formData.append('content', content);

            const response = await fetch('/api/daily/memos/quick', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('메모 추가 실패');
            }

            // 입력창 초기화
            memoInput.value = '';
            document.getElementById('memo-char-count').textContent = '0';
        }

        // 메모 목록 새로고침
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        const operation = currentEditingMemoId ? '수정' : '추가';
        console.error(`메모 ${operation} 오류:`, error);
        alert(`메모 ${operation} 중 오류가 발생했습니다.`);
    }
});

// Enter 키로 메모 추가/수정, ESC 키로 수정 취소
document.getElementById('memo-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('add-memo-btn').click();
    } else if (e.key === 'Escape' && currentEditingMemoId) {
        e.preventDefault();
        resetMemoInputMode();
    }
});

// 메모 삭제
async function deleteMemo(memoId) {
    if (!confirm('이 메모를 삭제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/api/daily/memos/${memoId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('메모 삭제 실패');
        }

        // 메모 목록 새로고침
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('메모 삭제 오류:', error);
        alert('메모 삭제 중 오류가 발생했습니다.');
    }
}

// 메모 수정
// 현재 수정 중인 메모 ID를 저장하는 변수
let currentEditingMemoId = null;

function editMemo(memoId, currentContent) {
    const memoInput = document.getElementById('memo-input');
    const addBtn = document.getElementById('add-memo-btn');
    const charCount = document.getElementById('memo-char-count');

    if (!memoInput || !addBtn || !charCount) {
        console.error('메모 입력 요소들을 찾을 수 없습니다.');
        return;
    }

    // 수정 모드로 전환
    currentEditingMemoId = memoId;
    memoInput.value = currentContent;
    charCount.textContent = currentContent.length;

    // 버튼 텍스트 변경 및 스타일 조정
    addBtn.textContent = '수정 완료';
    addBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium';

    // 입력창에 포커스
    memoInput.focus();

    // 커서를 텍스트 끝으로 이동
    memoInput.setSelectionRange(memoInput.value.length, memoInput.value.length);
}

// 메모 입력 모드를 초기 상태로 리셋
function resetMemoInputMode() {
    const memoInput = document.getElementById('memo-input');
    const addBtn = document.getElementById('add-memo-btn');
    const charCount = document.getElementById('memo-char-count');

    if (!memoInput || !addBtn || !charCount) {
        console.error('메모 입력 요소들을 찾을 수 없습니다.');
        return;
    }

    // 수정 모드 해제
    currentEditingMemoId = null;

    // 입력창 초기화
    memoInput.value = '';
    charCount.textContent = '0';

    // 버튼을 원래 상태로 복원
    addBtn.textContent = '메모 추가';
    addBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium';
}

// 메모 업데이트
async function updateMemo(memoId, content) {
    try {
        const formData = new FormData();
        formData.append('content', content);

        const response = await fetch(`/api/daily/memos/${memoId}`, {
            method: 'PUT',
            body: formData
        });

        if (!response.ok) {
            throw new Error('메모 수정 실패');
        }

    } catch (error) {
        console.error('메모 수정 오류:', error);
        alert('메모 수정 중 오류가 발생했습니다.');
    }
}

// 전체 메모 삭제
document.getElementById('clear-all-memos').addEventListener('click', async () => {
    if (!confirm('오늘의 모든 메모를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
        return;
    }

    try {
        // 먼저 오늘의 메모 목록을 가져온다
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('메모 목록 조회 실패');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (memos.length === 0) {
            alert('삭제할 메모가 없습니다.');
            return;
        }

        // 각 메모를 개별적으로 삭제
        let deletedCount = 0;
        for (const memo of memos) {
            try {
                const deleteResponse = await fetch(`/api/daily/memos/${memo.id}`, {
                    method: 'DELETE'
                });
                if (deleteResponse.ok) {
                    deletedCount++;
                }
            } catch (deleteError) {
                console.error(`메모 ${memo.id} 삭제 실패:`, deleteError);
            }
        }

        alert(`${deletedCount}개의 메모가 삭제되었습니다.`);

        // 메모 목록 새로고침
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('전체 메모 삭제 오류:', error);
        alert('메모 삭제 중 오류가 발생했습니다.');
    }
});

// === 모바일 메모 기능 ===
// 모바일 메모 토글 버튼 (null 체크 추가)
const mobileToggleBtn = document.getElementById('mobile-memo-toggle');
if (mobileToggleBtn) {
    mobileToggleBtn.addEventListener('click', () => {
        const mobileModal = document.getElementById('mobile-memo-modal');
        if (mobileModal) {
            mobileModal.classList.remove('hidden');
            // 모바일에서 메모를 열 때 최신 메모 목록 로드
            loadMemosBasedOnScreenSize();
        }
    });
}

// 모바일 메모 모달 닫기 (null 체크 추가)
const closeMobileBtn = document.getElementById('close-mobile-memo');
if (closeMobileBtn) {
    closeMobileBtn.addEventListener('click', () => {
        const mobileModal = document.getElementById('mobile-memo-modal');
        if (mobileModal) {
            mobileModal.classList.add('hidden');
        }
    });
}

// 모바일 메모 입력 글자 수 카운터 (null 체크 추가)
const mobileMemoInput = document.getElementById('mobile-memo-input');
const mobileMemoCounter = document.getElementById('mobile-memo-counter');

if (mobileMemoInput && mobileMemoCounter) {
    mobileMemoInput.addEventListener('input', () => {
    const length = mobileMemoInput.value.length;
    mobileMemoCounter.textContent = `${length}/500`;

    if (length > 500) {
        mobileMemoCounter.classList.add('text-red-500');
        mobileMemoCounter.classList.remove('text-gray-500');
    } else {
        mobileMemoCounter.classList.remove('text-red-500');
        mobileMemoCounter.classList.add('text-gray-500');
    }
    });
}

// 모바일 메모 추가 (null 체크 추가)
const addMobileMemoBtn = document.getElementById('add-mobile-memo');
if (addMobileMemoBtn && mobileMemoInput && mobileMemoCounter) {
    addMobileMemoBtn.addEventListener('click', async () => {
    const content = mobileMemoInput.value.trim();

    if (!content) {
        alert('메모 내용을 입력해주세요.');
        return;
    }

    if (content.length > 500) {
        alert('메모는 500자를 초과할 수 없습니다.');
        return;
    }

    try {
        const response = await fetch('/api/daily/memos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content
            })
        });

        if (!response.ok) {
            throw new Error('메모 추가 실패');
        }

        // 입력 필드 클리어
        mobileMemoInput.value = '';
        mobileMemoCounter.textContent = '0/500';

        // 모바일과 데스크톱 메모 목록 모두 새로고침
        await loadMemosBasedOnScreenSize();

        // 간단한 피드백
        const button = document.getElementById('add-mobile-memo');
        const originalText = button.textContent;
        button.textContent = '✓ 추가됨';
        button.disabled = true;

        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 1000);

    } catch (error) {
        console.error('모바일 메모 추가 오류:', error);
        alert('메모 추가 중 오류가 발생했습니다.');
    }
    });
}


// 메모 이벤트 리스너 등록 (동적 생성된 버튼용 - 데스크톱과 모바일 공통)
document.addEventListener('click', async function(e) {
    // 데스크톱 메모 편집 버튼
    if (e.target.classList.contains('desktop-edit-memo-btn') || e.target.closest('.desktop-edit-memo-btn')) {
        const button = e.target.classList.contains('desktop-edit-memo-btn') ? e.target : e.target.closest('.desktop-edit-memo-btn');
        const memoId = button.dataset.memoId;
        const currentContent = button.dataset.memoContent;

        // HTML 엔티티 디코딩
        const decodedContent = currentContent
            .replace(/&#39;/g, "'")
            .replace(/&quot;/g, '"')
            .replace(/&gt;/g, '>')
            .replace(/&lt;/g, '<')
            .replace(/&amp;/g, '&');

        // 새로운 인라인 편집 방식 사용
        editMemo(memoId, decodedContent);
    }

    // 데스크톱 메모 삭제 버튼
    if (e.target.classList.contains('desktop-delete-memo-btn') || e.target.closest('.desktop-delete-memo-btn')) {
        const button = e.target.classList.contains('desktop-delete-memo-btn') ? e.target : e.target.closest('.desktop-delete-memo-btn');
        const memoId = button.dataset.memoId;

        if (!confirm('이 메모를 삭제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('메모 삭제 실패');
            }

            // 데스크톱과 모바일 메모 목록 모두 새로고침
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('데스크톱 메모 삭제 오류:', error);
            alert('메모 삭제 중 오류가 발생했습니다.');
        }
    }

    // 모바일 메모 편집 버튼
    if (e.target.classList.contains('mobile-edit-memo-btn')) {
        const memoId = e.target.dataset.memoId;
        const currentContent = e.target.dataset.memoContent;

        // HTML 엔티티 디코딩
        const decodedContent = currentContent
            .replace(/&#39;/g, "'")
            .replace(/&quot;/g, '"')
            .replace(/&gt;/g, '>')
            .replace(/&lt;/g, '<')
            .replace(/&amp;/g, '&');

        const newContent = prompt('메모 수정:', decodedContent);

        if (newContent === null) return; // 취소

        if (!newContent.trim()) {
            alert('메모 내용을 입력해주세요.');
            return;
        }

        if (newContent.length > 500) {
            alert('메모는 500자를 초과할 수 없습니다.');
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: newContent.trim()
                })
            });

            if (!response.ok) {
                throw new Error('메모 수정 실패');
            }

            // 모바일과 데스크톱 메모 목록 모두 새로고침
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('모바일 메모 수정 오류:', error);
            alert('메모 수정 중 오류가 발생했습니다.');
        }
    }

    // 모바일 메모 삭제 버튼
    if (e.target.classList.contains('mobile-delete-memo-btn')) {
        const memoId = e.target.dataset.memoId;

        if (!confirm('이 메모를 삭제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/daily/memos/${memoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('메모 삭제 실패');
            }

            // 모바일과 데스크톱 메모 목록 모두 새로고침
            await loadMemosBasedOnScreenSize();
            await loadMemosBasedOnScreenSize();

        } catch (error) {
            console.error('모바일 메모 삭제 오류:', error);
            alert('메모 삭제 중 오류가 발생했습니다.');
        }
    }
});

// 모바일 전체 메모 삭제 (null 체크 추가)
const mobileClearAllBtn = document.getElementById('mobile-clear-all-memos');
if (mobileClearAllBtn) {
    mobileClearAllBtn.addEventListener('click', async () => {
    if (!confirm('오늘의 모든 메모를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
        return;
    }

    try {
        // 먼저 오늘의 메모 목록을 가져온다
        const response = await fetch('/api/daily/memos/today');
        if (!response.ok) {
            throw new Error('메모 목록 조회 실패');
        }

        const data = await response.json();
        const memos = data.memos || [];

        if (memos.length === 0) {
            alert('삭제할 메모가 없습니다.');
            return;
        }

        // 각 메모를 개별적으로 삭제
        let deletedCount = 0;
        for (const memo of memos) {
            try {
                const deleteResponse = await fetch(`/api/daily/memos/${memo.id}`, {
                    method: 'DELETE'
                });
                if (deleteResponse.ok) {
                    deletedCount++;
                }
            } catch (deleteError) {
                console.error(`메모 ${memo.id} 삭제 실패:`, deleteError);
            }
        }

        alert(`${deletedCount}개의 메모가 삭제되었습니다.`);

        // 모바일과 데스크톱 메모 목록 모두 새로고침
        await loadMemosBasedOnScreenSize();

    } catch (error) {
        console.error('모바일 전체 메모 삭제 오류:', error);
        alert('메모 삭제 중 오류가 발생했습니다.');
    }
});
}
</script>
</body>
</html>