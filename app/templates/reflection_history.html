<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_dev %}[DEV] {% endif %}íšŒê³  íˆìŠ¤í† ë¦¬ - Daily Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- ê°œë°œ í™˜ê²½ ë°°ë„ˆ -->
    {% if app_env == "dev" %}
    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 px-4 text-center font-semibold shadow-md">
        ğŸš§ ê°œë°œ í™˜ê²½ (DEV) - í¬íŠ¸ 8000 | DB: {{ database_url.split('/')[-1] }}
    </div>
    {% endif %}

<div class="min-h-screen bg-gray-50">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64 py-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">ğŸ“” íšŒê³  íˆìŠ¤í† ë¦¬</h1>

                    <!-- ì£¼ê°„ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <div class="flex items-center mt-2 space-x-4">
                        <!-- ì´ì „/ë‹¤ìŒ ì£¼ ë²„íŠ¼ -->
                        <div class="flex items-center space-x-2">
                            <a href="/reflection-history?week_start={{ prev_monday.strftime('%Y-%m-%d') }}"
                               class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                               title="ì´ì „ ì£¼">
                                <i class="fas fa-chevron-left"></i>
                            </a>

                            <div class="text-center">
                                <div class="text-sm sm:text-base text-gray-900 font-medium">{{ current_week }}</div>
                                {% if is_current_week %}
                                <div class="text-xs text-blue-600 font-medium">ì´ë²ˆ ì£¼</div>
                                {% endif %}
                            </div>

                            <a href="/reflection-history?week_start={{ next_monday.strftime('%Y-%m-%d') }}"
                               class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors"
                               title="ë‹¤ìŒ ì£¼">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>

                        <!-- ë‹¬ë ¥ ì„ íƒê¸° -->
                        <div class="relative">
                            <button onclick="toggleDatePicker()"
                                    class="flex items-center px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                                <i class="fas fa-calendar-alt mr-2 text-gray-500"></i>
                                <span class="hidden sm:inline">ì£¼ ì„ íƒ</span>
                            </button>

                            <!-- ë‹¬ë ¥ ë“œë¡­ë‹¤ìš´ -->
                            <div id="date-picker" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-50 p-4">
                                <div class="text-sm font-medium text-gray-900 mb-3">ì£¼ ì„ íƒí•˜ê¸°</div>
                                <input type="week"
                                       id="week-input"
                                       value="{{ monday.strftime('%Y-W%U') }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onchange="navigateToWeek(this.value)">
                                <div class="mt-3 flex space-x-2">
                                    <button onclick="goToCurrentWeek()"
                                            class="flex-1 px-3 py-2 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        ì´ë²ˆ ì£¼ë¡œ
                                    </button>
                                    <button onclick="toggleDatePicker()"
                                            class="flex-1 px-3 py-2 text-xs bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                                        ì·¨ì†Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right">
                    <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                        â† ì˜¤ëŠ˜ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- ë°ìŠ¤í¬íƒ‘ ì‚¬ì´ë“œë°” -->
    <aside class="hidden lg:block fixed left-0 top-0 h-full w-64 bg-white border-r border-gray-200 z-40">
        <div class="p-6">
            <div class="flex items-center mb-8">
                <h2 class="text-xl font-bold text-gray-900">âš¡ Daily Flow</h2>
            </div>

            <nav class="space-y-2">
                <a href="/" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ì˜¤ëŠ˜ì˜ í•  ì¼
                </a>
                <a href="/reflection-history" class="flex items-center px-4 py-3 text-blue-600 bg-blue-50 rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    íšŒê³  íˆìŠ¤í† ë¦¬
                </a>
                <a href="/projects" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                    </svg>
                    ì—¬ì • ê´€ë¦¬
                </a>
            </nav>
        </div>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64">

        <!-- ì£¼ê°„ ìš”ì•½ -->
        <div class="mt-6">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <h2 class="text-lg font-medium text-gray-900 mb-4">ğŸ“Š ì´ë²ˆ ì£¼ ìš”ì•½</h2>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                    {% set total_week_todos = weekly_stats|sum(attribute='total_todos') %}
                    {% set completed_week_todos = weekly_stats|sum(attribute='completed_todos') %}
                    {% set week_completion_rate = (completed_week_todos / total_week_todos * 100) if total_week_todos > 0 else 0 %}

                    <div class="text-center">
                        <div class="text-2xl sm:text-3xl font-bold text-blue-600">{{ "%.1f"|format(week_completion_rate) }}%</div>
                        <div class="text-xs sm:text-sm text-gray-500">ì£¼ê°„ ì™„ë£Œìœ¨</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl sm:text-3xl font-bold text-green-600">{{ completed_week_todos }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">ì™„ë£Œí•œ í• ì¼</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl sm:text-3xl font-bold text-gray-600">{{ total_week_todos }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">ì „ì²´ í• ì¼</div>
                    </div>
                    <div class="text-center">
                        {% if week_averages.avg_satisfaction > 0 %}
                        <div class="text-2xl sm:text-3xl font-bold text-yellow-600">{{ "%.1f"|format(week_averages.avg_satisfaction) }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">í‰ê·  ë§Œì¡±ë„</div>
                        {% else %}
                        <div class="text-2xl sm:text-3xl font-bold text-gray-400">-</div>
                        <div class="text-xs sm:text-sm text-gray-500">í‰ê·  ë§Œì¡±ë„</div>
                        {% endif %}
                    </div>
                    <div class="text-center">
                        {% if week_averages.avg_energy > 0 %}
                        <div class="text-2xl sm:text-3xl font-bold text-purple-600">{{ "%.1f"|format(week_averages.avg_energy) }}</div>
                        <div class="text-xs sm:text-sm text-gray-500">í‰ê·  ì—ë„ˆì§€</div>
                        {% else %}
                        <div class="text-2xl sm:text-3xl font-bold text-gray-400">-</div>
                        <div class="text-xs sm:text-sm text-gray-500">í‰ê·  ì—ë„ˆì§€</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¼ë³„ ì§„í–‰ ìƒí™© (ì•„ì½”ë””ì–¸) -->
        <div class="mt-6">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <h2 class="text-lg font-medium text-gray-900 mb-4">ğŸ“… ì¼ë³„ íšŒê³  íˆìŠ¤í† ë¦¬</h2>

                <div class="space-y-3">
                    {% for day_stat in weekly_stats %}
                    <div class="accordion-item border rounded-lg transition-all duration-200 hover:shadow-md"
                         data-date="{{ day_stat.date.strftime('%Y-%m-%d') }}">
                        <!-- í—¤ë” (í´ë¦­ ê°€ëŠ¥) -->
                        <div class="{% if day_stat.is_today %}bg-blue-50 border-blue-200{% else %}bg-gray-50{% endif %} cursor-pointer p-4 rounded-lg"
                             onclick="toggleAccordion('{{ day_stat.date.strftime('%Y-%m-%d') }}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-gray-900">{{ day_stat.day_korean }}</div>
                                        <div class="text-xs text-gray-500">{{ day_stat.date.strftime('%m/%d') }}</div>
                                    </div>

                                    {% if day_stat.is_today %}
                                    <div class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full">ì˜¤ëŠ˜</div>
                                    {% endif %}

                                    <!-- íšŒê³  ìƒíƒœ ì•„ì´ì½˜ -->
                                    {% if day_stat.has_reflection %}
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span class="text-xs text-green-600 font-medium">íšŒê³  ì™„ë£Œ</span>
                                        <!-- ë§Œì¡±ë„ í‘œì‹œ -->
                                        {% if day_stat.satisfaction_score %}
                                        <div class="text-yellow-500 text-sm ml-2">
                                            {% for i in range(1, 6) %}
                                                {% if i <= day_stat.satisfaction_score %}â˜…{% else %}â˜†{% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <!-- ì—ë„ˆì§€ í‘œì‹œ -->
                                        {% if day_stat.energy_level %}
                                        <div class="text-blue-500 text-sm ml-1">
                                            {% if day_stat.energy_level >= 4 %}âš¡{% elif day_stat.energy_level >= 3 %}ğŸ”‹{% elif day_stat.energy_level >= 2 %}ğŸ”‹{% else %}ğŸª«{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="flex items-center space-x-1">
                                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                        <span class="text-xs text-gray-500">íšŒê³  ë¯¸ì‘ì„±</span>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ day_stat.completed_todos }}/{{ day_stat.total_todos }}
                                        </div>
                                        <div class="text-xs text-gray-500">í• ì¼ ì™„ë£Œ</div>
                                    </div>

                                    <div class="w-20">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-xs text-gray-500">ì™„ë£Œìœ¨</span>
                                            <span class="text-xs font-medium text-gray-900">{{ "%.0f"|format(day_stat.completion_rate) }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="{% if day_stat.completion_rate >= 80 %}bg-green-500{% elif day_stat.completion_rate >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-2 rounded-full transition-all duration-300"
                                                 style="width: {{ day_stat.completion_rate }}%"></div>
                                        </div>
                                    </div>

                                    <!-- ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ -->
                                    <div class="accordion-arrow transition-transform duration-200">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì•„ì½”ë””ì–¸ ë‚´ìš© (ê¸°ë³¸ ìˆ¨ê¹€) -->
                        <div class="accordion-content hidden border-t bg-white p-4"
                             id="accordion-{{ day_stat.date.strftime('%Y-%m-%d') }}">
                            <div class="loading-indicator text-center text-gray-500 py-4">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                ë°ì´í„° ë¡œë”© ì¤‘...
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- í™œì„± ì—¬ì • í˜„í™© -->
        {% if journey_data %}
        <div class="mt-6">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <h2 class="text-lg font-medium text-gray-900 mb-4">ğŸ¯ í™œì„± ì—¬ì •</h2>

                <div class="space-y-4">
                    {% for data in journey_data %}
                    {% set journey = data.journey %}
                    {% set actual_progress = data.actual_progress %}
                    <div class="border rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="font-medium text-gray-900">{{ journey.title }}</h3>
                                {% if journey.description %}
                                <p class="text-sm text-gray-600 mt-1">{{ journey.description }}</p>
                                {% endif %}
                            </div>

                            <div class="ml-4 text-right">
                                <div class="text-sm font-medium text-purple-600">{{ data.completed_todos }}/{{ data.total_todos }}</div>
                                <div class="text-xs text-gray-500">ì™„ë£Œ/ì „ì²´</div>
                            </div>
                        </div>

                        <div class="text-sm text-gray-600 mt-2">
                            <span class="font-medium">ì‘ì—… í˜„í™©:</span>
                            <span class="ml-2">
                                ì™„ë£Œ <span class="font-semibold text-green-600">{{ data.completed_todos }}ê°œ</span> /
                                ì „ì²´ <span class="font-semibold text-gray-800">{{ data.total_todos }}ê°œ</span>
                            </span>
                        </div>

                        <div class="flex items-center justify-between mt-3">
                            <span class="px-2 py-1 text-xs font-medium bg-{{ 'green' if journey.status.value == 'ì§„í–‰ì¤‘' else 'gray' }}-100 text-{{ 'green' if journey.status.value == 'ì§„í–‰ì¤‘' else 'gray' }}-700 rounded-full">
                                {{ journey.status.value }}
                            </span>

                            {% if journey.end_date %}
                            <span class="text-xs text-gray-500">
                                ë§ˆê°: {{ journey.end_date.strftime('%Y-%m-%d') }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ì£¼ê°„ ì•¡ì…˜ -->
        <div class="mt-6 mb-20 lg:mb-8">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border">
                <h2 class="text-lg font-medium text-gray-900 mb-4">âš¡ ë¹ ë¥¸ ì•¡ì…˜</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <a href="/" class="flex items-center p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg mr-3">
                            <i class="fas fa-plus text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">ìƒˆ í• ì¼ ì¶”ê°€</div>
                            <div class="text-sm text-gray-500">ì˜¤ëŠ˜ í• ì¼ ë§Œë“¤ê¸°</div>
                        </div>
                    </a>

                    <a href="/reflection-history" class="flex items-center p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-center w-10 h-10 bg-purple-100 rounded-lg mr-3">
                            <i class="fas fa-book text-purple-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">íšŒê³  ë¦¬ìŠ¤íŠ¸</div>
                            <div class="text-sm text-gray-500">ì „ì²´ íšŒê³  ë³´ê¸°</div>
                        </div>
                    </a>

                    <a href="/projects" class="flex items-center p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-center w-10 h-10 bg-green-100 rounded-lg mr-3">
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">ì—¬ì • ê´€ë¦¬</div>
                            <div class="text-sm text-gray-500">ì „ì²´ í˜„í™© ë³´ê¸°</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë°”ì¼ë§Œ) -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-around py-3">
                <a href="/" class="flex flex-col items-center py-2 px-4 text-gray-400">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs mt-1">ì˜¤ëŠ˜</span>
                </a>
                <a href="/reflection-history" class="flex flex-col items-center py-2 px-4 text-blue-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="text-xs mt-1">íšŒê³ </span>
                </a>
                <a href="/projects" class="flex flex-col items-center py-2 px-4 text-gray-400">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                    </svg>
                    <span class="text-xs mt-1">ì—¬ì •</span>
                </a>
            </div>
        </div>
    </nav>
</div>

<!-- íšŒê³  ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="reflection-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-title">íšŒê³  ìƒì„¸ë³´ê¸°</h3>
                <button onclick="closeReflectionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]" id="modal-content">
                <!-- ëª¨ë‹¬ ë‚´ìš©ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
            <div class="flex items-center justify-end space-x-3 p-6 border-t bg-gray-50">
                <button onclick="closeReflectionModal()"
                        class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    ë‹«ê¸°
                </button>
                <button onclick="showLLMBlogModal()"
                        class="px-4 py-2 text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                    <i class="fas fa-robot mr-2"></i>
                    AI ë¸”ë¡œê·¸ ê¸€ ìƒì„±
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ë³´ê¸° ëª¨ë‹¬ -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 z-60 hidden" onclick="closeImageModal()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative max-w-4xl max-h-[90vh] w-full">
            <button onclick="closeImageModal()"
                    class="absolute top-4 right-4 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2 z-10">
                <i class="fas fa-times text-xl"></i>
            </button>
            <img id="modal-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
            <div id="modal-image-title" class="absolute bottom-4 left-4 right-4 text-white bg-black bg-opacity-50 rounded p-2 text-center"></div>
        </div>
    </div>
</div>

<!-- LLM ë¸”ë¡œê·¸ ê¸€ ìƒì„± ëª¨ë‹¬ -->
<div id="llm-blog-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">ğŸ¤– AI ë¸”ë¡œê·¸ ê¸€ ìƒì„±</h3>
                <button onclick="closeLLMBlogModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <form id="llm-blog-form" onsubmit="generateLLMBlog(event)">
                    <!-- AI ëª¨ë¸ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">AI ëª¨ë¸ ì„ íƒ</label>
                        <select name="provider" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="openai">OpenAI GPT-4o (ë¸”ë¡œê·¸ ê¸€ í’ˆì§ˆ ìš°ìˆ˜)</option>
                            <option value="claude">Claude 3.5 Sonnet (ì°½ì‘ ëŠ¥ë ¥ ìš°ìˆ˜)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ìµœì í™”ëœ ëª¨ë¸ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤</p>
                    </div>


                    <!-- ì´ë¯¸ì§€ í¬í•¨ ì—¬ë¶€ -->
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="include_images" checked
                                   class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">í• ì¼ ì™„ë£Œ ì´ë¯¸ì§€ í¬í•¨</span>
                        </label>
                    </div>

                    <!-- ì¶”ê°€ í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­) -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ì„ íƒì‚¬í•­)</label>
                        <textarea name="additional_prompt" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="ì˜ˆ: ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”, ì´ëª¨ì§€ë¥¼ ë§ì´ ì‚¬ìš©í•´ì£¼ì„¸ìš”"></textarea>
                    </div>

                    <!-- ìƒì„± ë²„íŠ¼ -->
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeLLMBlogModal()"
                                class="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                            <i class="fas fa-magic mr-2"></i>
                            ìƒì„±
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ë¸”ë¡œê·¸ ê¸€ ê²°ê³¼ í‘œì‹œ ëª¨ë‹¬ -->
<div id="blog-result-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900" id="blog-result-title">ğŸ‰ AI ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì™„ë£Œ</h3>
                <button onclick="closeBlogResultModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]" id="blog-result-content">
                <!-- ìƒì„±ëœ ë¸”ë¡œê·¸ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="flex items-center justify-between p-6 border-t bg-gray-50">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <span id="cache-status"></span>
                    <span id="generation-time"></span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="regenerateBlog()"
                            class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        <i class="fas fa-redo mr-2"></i>
                        ì¬ìƒì„±
                    </button>
                    <button onclick="copyBlogToClipboard()"
                            class="px-4 py-2 text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100">
                        <i class="fas fa-copy mr-2"></i>
                        ë³µì‚¬
                    </button>
                    <button onclick="closeBlogResultModal()"
                            class="px-4 py-2 text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                        ì™„ë£Œ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- íšŒê³  ì‘ì„± ëª¨ë‹¬ -->
<div id="reflection-write-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900" id="write-modal-title">ğŸ“ íšŒê³  ì‘ì„±</h3>
                <button onclick="closeReflectionWriteModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="reflection-write-form" onsubmit="submitReflection(event)" class="p-6 overflow-y-auto max-h-[70vh]">
                <input type="hidden" id="write-reflection-date" name="reflection_date">

                <!-- íšŒê³  ë‚´ìš© -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-900 mb-2">íšŒê³  ë‚´ìš© *</label>
                    <textarea
                        name="reflection_text"
                        required
                        rows="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ë˜ëŒì•„ë³´ë©° ëŠë‚€ ì , ë°°ìš´ ì , ê°œì„ í•  ì  ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                </div>

                <!-- ë§Œì¡±ë„ & ì—ë„ˆì§€ ë ˆë²¨ -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ë§Œì¡±ë„ (ì„ íƒ)</label>
                        <select name="satisfaction_score"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">ì„ íƒ ì•ˆ í•¨</option>
                            <option value="1">â­ 1ì  (ë§¤ìš° ë¶ˆë§Œì¡±)</option>
                            <option value="2">â­â­ 2ì  (ë¶ˆë§Œì¡±)</option>
                            <option value="3">â­â­â­ 3ì  (ë³´í†µ)</option>
                            <option value="4">â­â­â­â­ 4ì  (ë§Œì¡±)</option>
                            <option value="5">â­â­â­â­â­ 5ì  (ë§¤ìš° ë§Œì¡±)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ì—ë„ˆì§€ ë ˆë²¨ (ì„ íƒ)</label>
                        <select name="energy_level"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">ì„ íƒ ì•ˆ í•¨</option>
                            <option value="1">ğŸª« 1ì  (ë§¤ìš° ë‚®ìŒ)</option>
                            <option value="2">ğŸ”‹ 2ì  (ë‚®ìŒ)</option>
                            <option value="3">ğŸ”‹ 3ì  (ë³´í†µ)</option>
                            <option value="4">ğŸ”‹ 4ì  (ë†’ìŒ)</option>
                            <option value="5">âš¡ 5ì  (ë§¤ìš° ë†’ìŒ)</option>
                        </select>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex items-center justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeReflectionWriteModal()"
                            class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // ë‹¬ë ¥ ì„ íƒê¸° í† ê¸€
    function toggleDatePicker() {
        const picker = document.getElementById('date-picker');
        picker.classList.toggle('hidden');
    }

    // ì£¼ ì„ íƒ ì‹œ ë„¤ë¹„ê²Œì´ì…˜
    function navigateToWeek(weekValue) {
        // weekValue í˜•ì‹: "2025-W39"
        const [year, weekStr] = weekValue.split('-W');
        const weekNum = parseInt(weekStr);

        // í•´ë‹¹ ë…„ë„ì˜ ì²« ë²ˆì§¸ ì›”ìš”ì¼ ê³„ì‚°
        const jan1 = new Date(parseInt(year), 0, 1);
        const firstMonday = new Date(jan1);

        // 1ì›” 1ì¼ì´ ì›”ìš”ì¼ì´ ì•„ë‹ˆë©´ ë‹¤ìŒ ì›”ìš”ì¼ë¡œ ì´ë™
        const dayOfWeek = jan1.getDay();
        if (dayOfWeek !== 1) { // ì›”ìš”ì¼ì´ ì•„ë‹ˆë©´
            const daysToAdd = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
            firstMonday.setDate(jan1.getDate() + daysToAdd);
        }

        // ì„ íƒí•œ ì£¼ì˜ ì›”ìš”ì¼ ê³„ì‚°
        const targetMonday = new Date(firstMonday);
        targetMonday.setDate(firstMonday.getDate() + (weekNum - 1) * 7);

        // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const mondayStr = targetMonday.toISOString().split('T')[0];

        // í˜ì´ì§€ ì´ë™
        window.location.href = `/reflection-history?week_start=${mondayStr}`;
    }

    // ì´ë²ˆ ì£¼ë¡œ ì´ë™
    function goToCurrentWeek() {
        window.location.href = '/reflection-history';
    }

    // ì•„ì½”ë””ì–¸ í† ê¸€
    function toggleAccordion(dateStr) {
        const accordionContent = document.getElementById(`accordion-${dateStr}`);
        const accordionItem = document.querySelector(`[data-date="${dateStr}"]`);
        const arrow = accordionItem.querySelector('.accordion-arrow i');

        if (accordionContent.classList.contains('hidden')) {
            // ì•„ì½”ë””ì–¸ ì—´ê¸°
            accordionContent.classList.remove('hidden');
            arrow.classList.replace('fa-chevron-down', 'fa-chevron-up');

            // ë°ì´í„° ë¡œë“œ
            loadAccordionData(dateStr);
        } else {
            // ì•„ì½”ë””ì–¸ ë‹«ê¸°
            accordionContent.classList.add('hidden');
            arrow.classList.replace('fa-chevron-up', 'fa-chevron-down');
        }
    }

    // ì•„ì½”ë””ì–¸ ë°ì´í„° ë¡œë“œ
    async function loadAccordionData(dateStr) {
        const contentDiv = document.getElementById(`accordion-${dateStr}`);
        const loadingIndicator = contentDiv.querySelector('.loading-indicator');

        try {
            loadingIndicator.style.display = 'block';

            const response = await fetch(`/api/reflection-day/${dateStr}`);
            const data = await response.json();

            loadingIndicator.style.display = 'none';

            // ì•„ì½”ë””ì–¸ ë‚´ìš© ë Œë”ë§
            contentDiv.innerHTML = renderAccordionContent(data);

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
            loadingIndicator.innerHTML = '<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>';
        }
    }

    // ì•„ì½”ë””ì–¸ ë‚´ìš© ë Œë”ë§
    function renderAccordionContent(data) {
        let html = '<div class="space-y-4">';

        // íšŒê³  ë‚´ìš©
        if (data.has_reflection) {
            html += `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-medium text-gray-900">ğŸ“ íšŒê³  ë‚´ìš©</h4>
                        <button onclick="showReflectionDetail('${data.date}')"
                                class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-external-link-alt mr-1"></i>ìƒì„¸ë³´ê¸°
                        </button>
                    </div>
                    <div class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${data.reflection.reflection_text || 'íšŒê³  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>

                    <div class="flex items-center space-x-4 mt-3 pt-3 border-t border-blue-200">
                        ${data.reflection.satisfaction_score ? `
                            <div class="flex items-center">
                                <span class="text-xs text-gray-600 mr-2">ë§Œì¡±ë„:</span>
                                <div class="text-yellow-500">
                                    ${'â˜…'.repeat(data.reflection.satisfaction_score)}${'â˜†'.repeat(5 - data.reflection.satisfaction_score)}
                                </div>
                            </div>
                        ` : ''}
                        ${data.reflection.energy_level ? `
                            <div class="flex items-center">
                                <span class="text-xs text-gray-600 mr-2">ì—ë„ˆì§€:</span>
                                <div class="text-blue-500">
                                    ${data.reflection.energy_level >= 4 ? 'âš¡' : data.reflection.energy_level >= 3 ? 'ğŸ”‹' : data.reflection.energy_level >= 2 ? 'ğŸ”‹' : 'ğŸª«'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="bg-gray-50 p-4 rounded-lg text-center">
                    <div class="text-gray-500 mb-3">
                        <i class="fas fa-edit text-3xl"></i>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">ì´ ë‚ ì˜ íšŒê³ ê°€ ì•„ì§ ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
                    <button onclick="showReflectionWriteModal('${data.date}')"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-pencil-alt mr-2"></i>
                        íšŒê³  ì‘ì„±í•˜ê¸°
                    </button>
                </div>
            `;
        }

        // í• ì¼ ëª©ë¡
        if ((data.todos.completed_on_time && data.todos.completed_on_time.length > 0) ||
            (data.todos.retroactively_completed && data.todos.retroactively_completed.length > 0) ||
            (data.todos.pending && data.todos.pending.length > 0)) {
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">ğŸ“‹ í• ì¼ ëª©ë¡</h4>

                    ${(data.todos.completed_on_time && data.todos.completed_on_time.length > 0) ? `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-green-600 mb-2">âœ… ë‹¹ì¼ ì™„ë£Œí•œ í• ì¼ (${data.todos.completed_on_time.length}ê°œ)</div>
                            <div class="space-y-2">
                                ${data.todos.completed_on_time.map(todo => `
                                    <div class="flex items-center text-sm text-gray-700 bg-green-50 p-2 rounded">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        <span class="line-through">${todo.title}</span>
                                        <span class="ml-auto text-xs text-gray-500">${todo.category}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${(data.todos.retroactively_completed && data.todos.retroactively_completed.length > 0) ? `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-orange-600 mb-2">ğŸ”„ ë‚˜ì¤‘ì— ì™„ë£Œí•œ í• ì¼ (${data.todos.retroactively_completed.length}ê°œ)</div>
                            <div class="space-y-2">
                                ${data.todos.retroactively_completed.map(todo => `
                                    <div class="flex items-center text-sm text-gray-700 bg-orange-50 border border-orange-200 p-2 rounded">
                                        <i class="fas fa-check-circle text-orange-500 mr-2"></i>
                                        <span class="line-through opacity-75">${todo.title}</span>
                                        <span class="ml-auto text-xs text-orange-600">íšŒê³  í›„ ì™„ë£Œ</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${(data.todos.pending && data.todos.pending.length > 0) ? `
                        <div>
                            <div class="text-sm font-medium text-red-600 mb-2">â³ ë¯¸ì™„ë£Œ í• ì¼ (${data.todos.pending.length}ê°œ)</div>
                            <div class="space-y-2">
                                ${data.todos.pending.map(todo => `
                                    <div class="flex items-center text-sm text-gray-700 bg-red-50 p-2 rounded">
                                        <i class="fas fa-clock text-red-500 mr-2"></i>
                                        <span>${todo.title}</span>
                                        <span class="ml-auto text-xs text-gray-500">${todo.category}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        html += '</div>';
        return html;
    }

    // íšŒê³  ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
    function showReflectionDetail(dateStr) {
        const modal = document.getElementById('reflection-detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        modalTitle.textContent = `${dateStr} íšŒê³  ìƒì„¸ë³´ê¸°`;
        modalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>ë¡œë”© ì¤‘...</div>';

        // í˜„ì¬ ëª¨ë‹¬ ì •ë³´ ì„¤ì •
        currentModalDate = dateStr;

        modal.classList.remove('hidden');

        // ìƒì„¸ ë°ì´í„° ë¡œë“œ
        loadReflectionDetail(dateStr);
    }

    // íšŒê³  ìƒì„¸ ë°ì´í„° ë¡œë“œ
    async function loadReflectionDetail(dateStr) {
        const modalContent = document.getElementById('modal-content');

        try {
            const response = await fetch(`/api/reflection-day/${dateStr}`);
            const data = await response.json();

            // íšŒê³  ID ì„¤ì • (ë¸”ë¡œê·¸ ë‚´ë³´ë‚´ê¸°ìš©)
            currentModalReflectionId = data.reflection.id;

            modalContent.innerHTML = renderReflectionDetail(data);

        } catch (error) {
            console.error('ìƒì„¸ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
            modalContent.innerHTML = '<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle mr-2"></i>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>';
        }
    }

    // íšŒê³  ìƒì„¸ ë‚´ìš© ë Œë”ë§
    function renderReflectionDetail(data) {
        if (!data.has_reflection) {
            return `
                <div class="text-center py-8">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-edit text-6xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">íšŒê³ ê°€ ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-600">ì´ ë‚ ì˜ íšŒê³ ë¥¼ ì•„ì§ ì‘ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }

        return `
            <div class="space-y-6">
                <!-- íšŒê³  í…ìŠ¤íŠ¸ -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">ğŸ“ íšŒê³  ë‚´ìš©</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">${data.reflection.reflection_text || 'íšŒê³  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                    </div>
                </div>

                <!-- ë§Œì¡±ë„ & ì—ë„ˆì§€ -->
                <div class="grid grid-cols-2 gap-4">
                    ${data.reflection.satisfaction_score ? `
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-900 mb-2">ë§Œì¡±ë„</h5>
                            <div class="text-yellow-500 text-xl">
                                ${'â˜…'.repeat(data.reflection.satisfaction_score)}${'â˜†'.repeat(5 - data.reflection.satisfaction_score)}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${data.reflection.satisfaction_score}/5ì </div>
                        </div>
                    ` : '<div class="bg-gray-50 p-4 rounded-lg text-center text-gray-500">ë§Œì¡±ë„ ë¯¸ì…ë ¥</div>'}

                    ${data.reflection.energy_level ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-900 mb-2">ì—ë„ˆì§€ ë ˆë²¨</h5>
                            <div class="text-blue-500 text-2xl">
                                ${data.reflection.energy_level >= 4 ? 'âš¡' : data.reflection.energy_level >= 3 ? 'ğŸ”‹' : data.reflection.energy_level >= 2 ? 'ğŸ”‹' : 'ğŸª«'}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${data.reflection.energy_level}/5ì </div>
                        </div>
                    ` : '<div class="bg-gray-50 p-4 rounded-lg text-center text-gray-500">ì—ë„ˆì§€ ë ˆë²¨ ë¯¸ì…ë ¥</div>'}
                </div>

                <!-- ì™„ë£Œ í†µê³„ -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">ğŸ“Š í• ì¼ ì™„ë£Œ í†µê³„</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-600">${data.reflection.completion_rate.toFixed(1)}%</div>
                            <div class="text-xs text-gray-500">ì™„ë£Œìœ¨</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600">${data.reflection.completed_todos}</div>
                            <div class="text-xs text-gray-500">ì™„ë£Œ</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-600">${data.reflection.total_todos}</div>
                            <div class="text-xs text-gray-500">ì „ì²´</div>
                        </div>
                    </div>
                </div>

                <!-- í• ì¼ ìƒì„¸ ëª©ë¡ -->
                ${((data.todos.completed_on_time && data.todos.completed_on_time.length > 0) ||
                   (data.todos.retroactively_completed && data.todos.retroactively_completed.length > 0) ||
                   (data.todos.pending && data.todos.pending.length > 0)) ? `
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">ğŸ“‹ í• ì¼ ìƒì„¸ ëª©ë¡</h4>

                        ${(data.todos.completed_on_time && data.todos.completed_on_time.length > 0) ? `
                            <div class="mb-4">
                                <div class="text-sm font-medium text-green-600 mb-2">âœ… ë‹¹ì¼ ì™„ë£Œí•œ í• ì¼</div>
                                <div class="space-y-2">
                                    ${data.todos.completed_on_time.map(todo => `
                                        <div class="flex items-start bg-green-50 p-3 rounded-lg">
                                            <i class="fas fa-check-circle text-green-500 mr-3 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 line-through">${todo.title}</div>
                                                <div class="text-xs text-gray-500 mt-1">${todo.category}</div>
                                                ${todo.completion_reflection ? `
                                                    <div class="text-sm text-gray-600 mt-2 italic">"${todo.completion_reflection}"</div>
                                                ` : ''}
                                                ${todo.completion_image_path ? `
                                                    <div class="mt-3">
                                                        <img src="${todo.completion_image_path}"
                                                             alt="í• ì¼ ì™„ë£Œ ì´ë¯¸ì§€"
                                                             class="max-w-full h-auto rounded-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow"
                                                             onclick="showImageModal('${todo.completion_image_path}', '${todo.title} ì™„ë£Œ ì´ë¯¸ì§€')"
                                                             style="max-height: 200px;">
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${(data.todos.retroactively_completed && data.todos.retroactively_completed.length > 0) ? `
                            <div class="mb-4">
                                <div class="text-sm font-medium text-orange-600 mb-2">ğŸ”„ ë‚˜ì¤‘ì— ì™„ë£Œí•œ í• ì¼</div>
                                <div class="space-y-2">
                                    ${data.todos.retroactively_completed.map(todo => `
                                        <div class="flex items-start bg-orange-50 border border-orange-200 p-3 rounded-lg">
                                            <i class="fas fa-check-circle text-orange-500 mr-3 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 line-through opacity-75">${todo.title}</div>
                                                <div class="text-xs text-orange-600 mt-1">${todo.category} â€¢ íšŒê³  ì‘ì„± í›„ ì™„ë£Œë¨</div>
                                                ${todo.completed_at ? `
                                                    <div class="text-xs text-orange-600 mt-1">ì™„ë£Œì¼: ${new Date(todo.completed_at).toLocaleDateString('ko-KR')}</div>
                                                ` : ''}
                                                ${todo.completion_reflection ? `
                                                    <div class="text-sm text-gray-600 mt-2 italic">"${todo.completion_reflection}"</div>
                                                ` : ''}
                                                ${todo.completion_image_path ? `
                                                    <div class="mt-3">
                                                        <img src="${todo.completion_image_path}"
                                                             alt="í• ì¼ ì™„ë£Œ ì´ë¯¸ì§€"
                                                             class="max-w-full h-auto rounded-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow"
                                                             onclick="showImageModal('${todo.completion_image_path}', '${todo.title} ì™„ë£Œ ì´ë¯¸ì§€')"
                                                             style="max-height: 200px;">
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${(data.todos.pending && data.todos.pending.length > 0) ? `
                            <div>
                                <div class="text-sm font-medium text-red-600 mb-2">â³ ë¯¸ì™„ë£Œ í• ì¼</div>
                                <div class="space-y-2">
                                    ${data.todos.pending.map(todo => `
                                        <div class="flex items-start bg-red-50 p-3 rounded-lg">
                                            <i class="fas fa-clock text-red-500 mr-3 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900">${todo.title}</div>
                                                <div class="text-xs text-gray-500 mt-1">${todo.category}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeReflectionModal() {
        document.getElementById('reflection-detail-modal').classList.add('hidden');
    }

    // í˜„ì¬ ëª¨ë‹¬ì˜ íšŒê³  IDì™€ ë‚ ì§œë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let currentModalReflectionId = null;
    let currentModalDate = null;

    // LLM ë¸”ë¡œê·¸ ëª¨ë‹¬ ì—´ê¸°
    function showLLMBlogModal() {
        if (!currentModalReflectionId) {
            alert('íšŒê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¨¼ì € ê¸°ì¡´ ë¸”ë¡œê·¸ ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
        checkExistingBlogContent();

        document.getElementById('llm-blog-modal').classList.remove('hidden');
    }

    // LLM ë¸”ë¡œê·¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeLLMBlogModal() {
        document.getElementById('llm-blog-modal').classList.add('hidden');
        // í¼ ì´ˆê¸°í™”
        const form = document.getElementById('llm-blog-form');
        form.reset();
        form.removeAttribute('data-regenerate');
        // ì œëª© ì´ˆê¸°í™”
        document.querySelector('#llm-blog-modal h3').textContent = 'ğŸ¤– AI ë¸”ë¡œê·¸ ê¸€ ìƒì„±';
    }

    // ê¸°ì¡´ ë¸”ë¡œê·¸ ê¸€ í™•ì¸
    async function checkExistingBlogContent() {
        try {
            const response = await fetch(`/api/reflections/${currentModalReflectionId}/blog-content`);
            if (response.ok) {
                const data = await response.json();
                // ê¸°ì¡´ ê¸€ì´ ìˆìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
                showBlogResult(data.content, true, data.generated_at);
                closeLLMBlogModal();
            }
        } catch (error) {
            // ê¸°ì¡´ ê¸€ì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒˆë¡œ ìƒì„±í•˜ë„ë¡ ëª¨ë‹¬ í‘œì‹œ
            console.log('ê¸°ì¡´ ë¸”ë¡œê·¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
        }
    }

    // LLM ë¸”ë¡œê·¸ ê¸€ ìƒì„±
    async function generateLLMBlog(event) {
        event.preventDefault();

        if (!currentModalReflectionId) {
            alert('íšŒê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const form = event.target;
        const formData = new FormData(form);

        // ë¡œë”© í‘œì‹œ
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ìƒì„± ì¤‘...';
        submitButton.disabled = true;

        try {
            const requestData = {
                provider: formData.get('provider'),
                include_images: formData.get('include_images') ? true : false,
                additional_prompt: formData.get('additional_prompt') || null
            };

            // ì¬ìƒì„± ëª¨ë“œì¸ì§€ í™•ì¸
            const isRegenerate = form.getAttribute('data-regenerate') === 'true';
            const endpoint = isRegenerate ? 'regenerate-blog' : 'generate-blog';

            const response = await fetch(`/api/reflections/${currentModalReflectionId}/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ë¸”ë¡œê·¸ ê¸€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            const data = await response.json();

            // ì„±ê³µ ì‹œ ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
            showBlogResult(data.content, data.is_cached, data.generated_at);
            closeLLMBlogModal();

        } catch (error) {
            console.error('ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì‹¤íŒ¨:', error);
            alert(`ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
        } finally {
            // ë¡œë”© ìƒíƒœ í•´ì œ
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    }

    // ë¸”ë¡œê·¸ ê¸€ ê²°ê³¼ í‘œì‹œ
    function showBlogResult(content, isCached, generatedAt) {
        const modal = document.getElementById('blog-result-modal');
        const title = document.getElementById('blog-result-title');
        const contentDiv = document.getElementById('blog-result-content');
        const cacheStatus = document.getElementById('cache-status');
        const generationTime = document.getElementById('generation-time');

        // ì œëª© ì„¤ì •
        title.textContent = isCached ? 'ğŸ“„ ê¸°ì¡´ ë¸”ë¡œê·¸ ê¸€' : 'ğŸ‰ AI ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì™„ë£Œ';

        // ì½˜í…ì¸  ì„¤ì • (ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜)
        contentDiv.innerHTML = `
            <div class="prose prose-blue max-w-none">
                <div class="bg-gray-50 p-6 rounded-lg border">
                    ${content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        // ìƒíƒœ ì •ë³´ ì„¤ì •
        cacheStatus.textContent = isCached ? 'ğŸ’¾ ìºì‹œëœ ë‚´ìš©' : 'âœ¨ ìƒˆë¡œ ìƒì„±ë¨';
        generationTime.textContent = generatedAt ? `ìƒì„± ì‹œê°„: ${new Date(generatedAt).toLocaleString('ko-KR')}` : '';

        // ê¸€ë¡œë²Œ ë³€ìˆ˜ì— ì €ì¥ (ì¬ìƒì„±ê³¼ ë³µì‚¬ë¥¼ ìœ„í•´)
        currentBlogContent = content;

        modal.classList.remove('hidden');
    }

    // ë¸”ë¡œê·¸ ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
    function closeBlogResultModal() {
        document.getElementById('blog-result-modal').classList.add('hidden');
    }

    // ë¸”ë¡œê·¸ ê¸€ ì¬ìƒì„±
    function regenerateBlog() {
        closeBlogResultModal();
        document.getElementById('llm-blog-modal').classList.remove('hidden');
        // ì¬ìƒì„±ì„ì„ í‘œì‹œí•˜ê¸° ìœ„í•´ ì œëª© ë³€ê²½
        document.querySelector('#llm-blog-modal h3').textContent = 'ğŸ”„ AI ë¸”ë¡œê·¸ ê¸€ ì¬ìƒì„±';

        // ì¬ìƒì„± ëª¨ë“œ í‘œì‹œ
        document.getElementById('llm-blog-form').setAttribute('data-regenerate', 'true');
    }

    // ë¸”ë¡œê·¸ ê¸€ í´ë¦½ë³´ë“œ ë³µì‚¬
    async function copyBlogToClipboard() {
        try {
            await navigator.clipboard.writeText(currentBlogContent);

            // ë³µì‚¬ ë²„íŠ¼ í”¼ë“œë°±
            const copyButton = document.querySelector('button[onclick="copyBlogToClipboard()"]');
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check mr-2"></i>ë³µì‚¬ë¨!';
            copyButton.classList.remove('text-blue-600', 'bg-blue-50', 'border-blue-200');
            copyButton.classList.add('text-green-600', 'bg-green-50', 'border-green-200');

            setTimeout(() => {
                copyButton.innerHTML = originalText;
                copyButton.classList.remove('text-green-600', 'bg-green-50', 'border-green-200');
                copyButton.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-200');
            }, 2000);

        } catch (error) {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
            alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê¸€ë¡œë²Œ ë³€ìˆ˜
    let currentBlogContent = '';

    // ë¸”ë¡œê·¸ ê¸€ ìƒì„± í•¨ìˆ˜ (ë ˆê±°ì‹œ ì§€ì›)
    async function exportReflectionToBlog() {
        if (!currentModalReflectionId) {
            alert('íšŒê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
            const response = await fetch(`/api/reflections/${currentModalReflectionId}/export?format=html`);
            if (!response.ok) {
                throw new Error('ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨');
            }

            const data = await response.json();

            // ìƒˆ ì°½ì—ì„œ ì½˜í…ì¸  í‘œì‹œ
            const newWindow = window.open('', '_blank');

            // ì•ˆì „í•˜ê²Œ HTML ìƒì„±
            newWindow.document.open();
            newWindow.document.write('<!DOCTYPE html>');
            newWindow.document.write('<html>');
            newWindow.document.write('<head>');
            newWindow.document.write('<title>íšŒê³  ë¸”ë¡œê·¸ ê¸€ - ' + currentModalDate + '</title>');
            newWindow.document.write('<meta charset="UTF-8">');
            newWindow.document.write('<style>');
            newWindow.document.write('body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; background: white; }');
            newWindow.document.write('.content { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }');
            newWindow.document.write('.content img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }');
            newWindow.document.write('.actions { position: fixed; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }');
            newWindow.document.write('button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 0 4px; }');
            newWindow.document.write('button:hover { background: #0056b3; }');
            newWindow.document.write('</style>');
            newWindow.document.write('</head>');
            newWindow.document.write('<body>');
            newWindow.document.write('<div class="actions">');
            newWindow.document.write('<button onclick="copyToClipboard()">ğŸ“‹ ë³µì‚¬</button>');
            newWindow.document.write('<button onclick="downloadAsFile()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>');
            newWindow.document.write('<button onclick="window.close()">âŒ ë‹«ê¸°</button>');
            newWindow.document.write('</div>');

            // ì½˜í…ì¸ ë¥¼ ì•ˆì „í•˜ê²Œ ì„¤ì •
            const contentElement = newWindow.document.createElement('div');
            contentElement.className = 'content';
            contentElement.innerHTML = data.content;
            newWindow.document.body.appendChild(contentElement);

            // ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
            const script = newWindow.document.createElement('script');
            script.textContent =
                'function copyToClipboard() {' +
                    'const content = document.querySelector(".content").innerHTML;' +
                    'navigator.clipboard.writeText(content).then(() => {' +
                        'alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");' +
                    '});' +
                '}' +
                'function downloadAsFile() {' +
                    'const content = document.querySelector(".content").innerHTML;' +
                    'const blob = new Blob([content], { type: "text/html" });' +
                    'const url = URL.createObjectURL(blob);' +
                    'const a = document.createElement("a");' +
                    'a.href = url;' +
                    'a.download = "reflection_' + currentModalDate + '.html";' +
                    'document.body.appendChild(a);' +
                    'a.click();' +
                    'document.body.removeChild(a);' +
                    'URL.revokeObjectURL(url);' +
                '}';
            newWindow.document.head.appendChild(script);

            newWindow.document.write('</body>');
            newWindow.document.write('</html>');
            newWindow.document.close();

        } catch (error) {
            console.error('ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì‹¤íŒ¨:', error);
            alert('ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ë‹¬ë ¥ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(event) {
        const picker = document.getElementById('date-picker');
        const button = event.target.closest('button[onclick="toggleDatePicker()"]');

        if (!picker.contains(event.target) && !button) {
            picker.classList.add('hidden');
        }
    });

    // ESC í‚¤ë¡œ ë‹¬ë ¥/ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.getElementById('date-picker').classList.add('hidden');
            document.getElementById('reflection-detail-modal').classList.add('hidden');
            document.getElementById('reflection-write-modal').classList.add('hidden');
        }
    });

    // íšŒê³  ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
    function showReflectionWriteModal(dateStr) {
        const modal = document.getElementById('reflection-write-modal');
        const modalTitle = document.getElementById('write-modal-title');
        const dateInput = document.getElementById('write-reflection-date');
        const form = document.getElementById('reflection-write-form');

        // ë‚ ì§œ ì„¤ì •
        dateInput.value = dateStr;
        modalTitle.textContent = `ğŸ“ ${dateStr} íšŒê³  ì‘ì„±`;

        // í¼ ì´ˆê¸°í™”
        form.reset();
        dateInput.value = dateStr; // reset í›„ ë‹¤ì‹œ ì„¤ì •

        modal.classList.remove('hidden');
    }

    // íšŒê³  ì‘ì„± ëª¨ë‹¬ ë‹«ê¸°
    function closeReflectionWriteModal() {
        const modal = document.getElementById('reflection-write-modal');
        modal.classList.add('hidden');
    }

    // íšŒê³  ì œì¶œ
    async function submitReflection(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        // ì œì¶œ ë²„íŠ¼ ì°¾ê¸°
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        try {
            // ë¡œë”© ìƒíƒœ
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...';
            submitButton.disabled = true;

            // FormDataë¥¼ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜ (ë¹ˆ ê°’ì€ nullë¡œ)
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value === '') {
                    data[key] = null;
                } else if (key === 'satisfaction_score' || key === 'energy_level') {
                    data[key] = value ? parseInt(value) : null;
                } else {
                    data[key] = value;
                }
            }

            // API í˜¸ì¶œ (FormData í˜•ì‹ìœ¼ë¡œ ì „ì†¡)
            const response = await fetch('/api/reflections/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'íšŒê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            const result = await response.json();

            // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            closeReflectionWriteModal();

            // ì„±ê³µ ë©”ì‹œì§€ ë° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            alert('âœ… íšŒê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload();

        } catch (error) {
            console.error('íšŒê³  ì €ì¥ ì‹¤íŒ¨:', error);
            alert(`âŒ íšŒê³  ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        } finally {
            // ë¡œë”© ìƒíƒœ í•´ì œ
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    }

    // ì•„ì½”ë””ì–¸ í—¤ë” ì—…ë°ì´íŠ¸ (íšŒê³  ì™„ë£Œ ìƒíƒœ ë°˜ì˜)
    function updateAccordionHeader(dateStr, reflectionData) {
        const accordionItem = document.querySelector(`[data-date="${dateStr}"]`);
        if (!accordionItem) return;

        const statusIndicator = accordionItem.querySelector('.flex.items-center.space-x-1');
        if (!statusIndicator) return;

        // íšŒê³  ì™„ë£Œ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
        statusIndicator.innerHTML = `
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-xs text-green-600 font-medium">íšŒê³  ì™„ë£Œ</span>
            ${reflectionData.satisfaction_score ? `
                <div class="text-yellow-500 text-sm ml-2">
                    ${'â˜…'.repeat(reflectionData.satisfaction_score)}${'â˜†'.repeat(5 - reflectionData.satisfaction_score)}
                </div>
            ` : ''}
            ${reflectionData.energy_level ? `
                <div class="text-blue-500 text-sm ml-1">
                    ${reflectionData.energy_level >= 4 ? 'âš¡' : reflectionData.energy_level >= 3 ? 'ğŸ”‹' : reflectionData.energy_level >= 2 ? 'ğŸ”‹' : 'ğŸª«'}
                </div>
            ` : ''}
        `;
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
    function showImageModal(imageSrc, title) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalTitle = document.getElementById('modal-image-title');

        modalImage.src = imageSrc;
        modalImage.alt = title;
        modalTitle.textContent = title;

        modal.classList.remove('hidden');

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', handleImageModalEscape);
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');

        // ESC í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        document.removeEventListener('keydown', handleImageModalEscape);
    }

    // ESC í‚¤ë¡œ ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
    function handleImageModalEscape(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    }

    // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ (í™”ì‚´í‘œ í‚¤)
    document.addEventListener('keydown', function(event) {
        // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” ë¬´ì‹œ
        if (event.target.tagName === 'INPUT') return;

        // ì´ë¯¸ì§€ ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•ŒëŠ” ë¬´ì‹œ
        const imageModal = document.getElementById('image-modal');
        if (!imageModal.classList.contains('hidden')) return;

        if (event.key === 'ArrowLeft') {
            // ì´ì „ ì£¼ë¡œ ì´ë™
            window.location.href = `/reflection-history?week_start={{ prev_monday.strftime('%Y-%m-%d') }}`;
        } else if (event.key === 'ArrowRight') {
            // ë‹¤ìŒ ì£¼ë¡œ ì´ë™
            window.location.href = `/reflection-history?week_start={{ next_monday.strftime('%Y-%m-%d') }}`;
        }
    });
</script>

</body>
</html>